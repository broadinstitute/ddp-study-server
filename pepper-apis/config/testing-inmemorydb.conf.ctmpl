# Use this file to run local tests using a disposable in-memory database
# while connecting to other environment-specific resources

{{with $environment := env "ENVIRONMENT"}}
{{with $version := env "VERSION"}}
{{with $gae := env "GAE"}}
{{with $testingConf := vault (printf "secret/pepper/%s/%s/testing" $environment $version)}}
{{with $auth0 := index $testingConf.Data "auth0"}}
{{with $testingAuth := index $testingConf.Data "auth0"}}
{{with $elasticsearchConf := vault (printf "secret/pepper/%s/%s/elasticsearch" $environment $version)}}

{
    # If set to true, tests will use MySQL from Docker container and dbUrl and housekeepingDbUrl will be ignored
    {{if eq $gae "true"}}
        "useDisposableTestDbs": false,
        "dbUrl": "jdbc:mysql://localhost:3306/studyservicedb?user=root&password=rootpw&characterEncoding=UTF-8&useLegacyDatetimeCode=false&serverTimezone=UTC&useSSL=false&sessionVariables=innodb_strict_mode=on,tx_isolation='READ-COMMITTED',sql_mode='TRADITIONAL'",
        "housekeepingDbUrl": "jdbc:mysql://localhost:3306/housekeepingdb?user=root&password=rootpw&characterEncoding=UTF-8&useLegacyDatetimeCode=false&serverTimezone=UTC&useSSL=false&sessionVariables=innodb_strict_mode=on,tx_isolation='READ-COMMITTED',sql_mode='TRADITIONAL'",
    {{else}}
        "useDisposableTestDbs": true,
    {{end}}
    "maxConnections": 50,
    "defaultTimezone": "{{$testingConf.Data.defaultTimezone}}",
    "port": 5556,
    "doLiquibase": true,
    "threadTimeout": 30000,
    "dsmBaseUrl": "http://localhost:9555",
    "dsmJwtSecret": "Dsm test secret!",
    "dsmJwtSigner": "org.broadinstitute.kdux",
    "dbInstanceId": "ddp-dev",
    "restrictRegisterRoute": false,
    "auth0": {
        "domain": "{{$auth0.domain}}",
        "domain2": "{{$auth0.domain2}}",
        "encryptionSecret": "{{$auth0.encryptionSecret}}",
        "clientId": "{{$auth0.clientId}}",
        "clientName":"{{$auth0.clientName}}",
        "clientSecret": "{{$auth0.clientSecret}}",
        "testUser": "{{$auth0.testUser}}",
        "testUserPassword": "{{$auth0.testUserPassword}}",
        "testUserAuth0Id": "{{$auth0.testUserAuth0Id}}",
        "testUserGuid": "{{$auth0.testUserGuid}}",
        "managementApiClientId": "{{$testingAuth.managementApiClientId}}",
        "managementApiClientId2": "{{$testingAuth.managementApiClientId2}}",
        "managementApiSecret": "{{$testingAuth.managementApiSecret}}",
        "managementApiSecret2": "{{$testingAuth.managementApiSecret2}}",
        "testAdmin": "{{$testingAuth.testAdmin}}",
        "testAdminPassword": "{{$testingAuth.testAdminPassword}}",
        "testAdminUserAuth0Id": "{{$testingAuth.testAdminUserAuth0Id}}",
        "dsmApiAudience": "https://dsm.datadonationplatform.org",
        "dsmClientId": "{{$testingAuth.dsmClientId}}",
        "dsmClientSecret": "{{$testingAuth.dsmClientSecret}}",
        "backendTestClientId": "{{$testingAuth.backendTestClientId}}",
        "backendTestClientId2": "{{$testingAuth.backendTestClientId2}}",
        "backendTestSecret": "{{$testingAuth.backendTestSecret}}",
        "backendTestSecret2": "{{$testingAuth.backendTestSecret2}}",
        "backendTestClientName": "{{$testingAuth.backendTestClientName}}",
        "backendTestClientName2": "{{$testingAuth.backendTestClientName2}}"
    },
    "googleGeocodingApiKey": "{{$testingConf.Data.geocodingKey}}",
    "elasticsearch": {
        "syncEnabled": false,
        "syncIntervalSecs": 10
    },
    "elasticsearchUrl": "http://localhost:9200",
    "elasticsearchPassword": "",
    "elasticsearchUsername": "",
    "elasticsearchBatchSize": 100,
    "healthcheckPassword": "{{$testingConf.Data.healthcheckPassword}}",
    "easyPostApiKey": "{{$testingConf.Data.easyPostApiKey}}",
    # by default, boot in-processs for testing.  change rendered .conf file manually for local development
    "bootTestAppInSeparateProcess": false,
    "apiBaseUrl": "http://localhost:5555",
    "baseTestUrl": "http://localhost:5556",
    "socialTestEmail": "{{$testingConf.Data.socialTestEmail}}",
    "socialTestPassword": "{{$testingConf.Data.socialTestPassword}}",
    "usePubSubEmulator": true,
    "runScheduler": false,
    "sendMetrics": false,
    "requireDefaultGcpCredentials": false,
    "googleProjectId": "broad-ddp-dev",
    "pdfArchiveBucket": "pepper-pdf-dev",
    "pdfArchiveUseFilesystem": true,
    "pubsub": {
        "enableHousekeepingTasks": false,
        "housekeepingTasksTopic": "local-housekeeping-tasks",
    },
    "studyExportBucket": "ddp-dev-study-exports-testing",
    "schedules": {
        "checkAgeUp": "0 0 7 ? * * *",
        "dbBackup": "0 30 4,10,14 ? * * *",
        "dbBackupCheck": "0 */30 * ? * *",
        "drugLoader": "0 0 8,20 ? * * *",
        "cancerLoader": "0 0 8,20 ? * * *",
        "studyExport": "0 0 9 ? * * *",
        "tempUserCleanup": "0 30 5 ? * * *"
    },
    "housekeepingMaxConnections": 50,
    "sendgrid": {
        "fromName": "Pepper Local",
        "fromEmail": "noreply@datadonationplatform.org"
    },
    "rateLimit": {
        "apiLimitBurst": 100,
        "apiLimitRate": 100
    },
    "sendgridToken": "{{$testingConf.Data.sendgridToken}}",
    "sendgridTemplates": {
        {{if eq $environment "dev"}}
             "currentActivity": {
                "template": "c3eb93e7-05a8-47c6-9c8c-4a6d88ca54cd"
             },
             "emailTesting": {
                "template": "6c1c165b-88ee-4b8f-98fc-04e0e73ba8ce",
                "version": "e6736bc3-d328-4c9f-bd02-4278b7c417bc"
             },
             "joinMailingList": {
                "template": "16a5de5a-3102-4527-911c-ae1869d5e3b8"
             },
             "userNotEnrolledInStudy": {
                 "template": "bfb0d8c1-f127-4ebf-a2fd-faef23b36a1f"
             }
         {{end}}
         {{if eq $environment "test"}}
              "currentActivity": {
                 "template": "c3eb93e7-05a8-47c6-9c8c-4a6d88ca54cd"
              },
              "emailTesting": {
                 "template": "6c1c165b-88ee-4b8f-98fc-04e0e73ba8ce",
                 "version": "e6736bc3-d328-4c9f-bd02-4278b7c417bc"
              },
              "joinMailingList": {
                  "template": "16a5de5a-3102-4527-911c-ae1869d5e3b8"
              },
              "userNotEnrolledInStudy": {
                   "template": "bfb0d8c1-f127-4ebf-a2fd-faef23b36a1f"
              }
          {{end}}
          {{if eq $environment "staging"}}
            "currentActivity": {
               "template": "c3eb93e7-05a8-47c6-9c8c-4a6d88ca54cd"
            },
            "emailTesting": {
               "template": "6c1c165b-88ee-4b8f-98fc-04e0e73ba8ce",
               "version": "e6736bc3-d328-4c9f-bd02-4278b7c417bc"
            },
            "joinMailingList": {
                "template": "16a5de5a-3102-4527-911c-ae1869d5e3b8"
            },
            "userNotEnrolledInStudy": {
                "template": "bfb0d8c1-f127-4ebf-a2fd-faef23b36a1f"
            }
        {{end}}
        {{if eq $environment "prod"}}
          "currentActivity": {
             "template": "c3eb93e7-05a8-47c6-9c8c-4a6d88ca54cd"
          },
          "emailTesting": {
             "template": "6c1c165b-88ee-4b8f-98fc-04e0e73ba8ce",
             "version": "e6736bc3-d328-4c9f-bd02-4278b7c417bc"
          },
          "joinMailingList": {
              "template": "16a5de5a-3102-4527-911c-ae1869d5e3b8"
          },
          "userNotEnrolledInStudy": {
              "template": "bfb0d8c1-f127-4ebf-a2fd-faef23b36a1f"
          }
      {{end}}
    }
}

{{end}}
{{end}}
{{end}}
{{end}}
{{end}}
{{end}}
{{end}}
