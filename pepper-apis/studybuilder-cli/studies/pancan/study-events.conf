{
  "events": [
    {
         "trigger": {
           "type": "ACTIVITY_STATUS",
           "activityCode": ${id.act.release_minor},
           "statusType": "COMPLETE"
         },
         "action": {
           "type": "ACTIVITY_INSTANCE_CREATION",
           "activityCode": ${id.act.stool_kit}
         },
         "preconditionExpr": ${_pex.addchild_has_colorectal}"""&& !user.studies["cmi-pancan"].forms["STOOL_KIT"].hasInstance()""",
         "maxOccurrencesPerUser": 1,
         "dispatchToHousekeeping": false,
         "order": 2
     },
     {
          "trigger": {
            "type": "ACTIVITY_STATUS",
            "activityCode": ${id.act.release},
            "statusType": "COMPLETE"
          },
          "action": {
            "type": "ACTIVITY_INSTANCE_CREATION",
            "activityCode": ${id.act.stool_kit}
          },
          "preconditionExpr": ${_pex.has_colorectal}"""&& !user.studies["cmi-pancan"].forms["STOOL_KIT"].hasInstance()""",
          "maxOccurrencesPerUser": 1,
          "dispatchToHousekeeping": false,
          "order": 2
     },
    # When prequal submitted
    ## Create consent activities
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.prequal},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.consent}
      },
      "preconditionExpr": ${_pex.is_self}"&&"${_pex.is_age_of_majority},
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.prequal},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.parental}
      },
      # We want to make sure we did not redirect. Other consent cases check the country, which is a
      # good indicator of not-redirected. We do the same here for parental case.
      "preconditionExpr": ${_pex.is_child_only}"&&"${_pex.is_country_answered}"&&"${_pex.is_age_parental},
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.prequal},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.assent}
      },
      # No need for country check here because `is_age_assent` already covers it.
      "preconditionExpr": ${_pex.is_child_only}"&&"${_pex.is_age_assent},
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 3
    },

    # When add-child submitted
    ## Create consent activities
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.add_child},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.parental}
      },
      # We want to make sure we did not redirect. Other consent cases check the country, which is a
      # good indicator of not-redirected. We do the same here for parental case.
      "preconditionExpr": ${_pex.addchild_is_country_answered}"&&"${_pex.addchild_is_age_parental},
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.add_child},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.assent}
      },
      # No need for country check here because `addchild_is_age_assent` already covers it.
      "preconditionExpr": ${_pex.addchild_is_age_assent},
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },

    # When user registered
    ## Send welcome email
    {
      "trigger": {
        "type": "USER_REGISTERED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_welcome}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_welcome}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    ## Queue announcement message
    {
      "trigger": {
        "type": "USER_REGISTERED"
      },
      "action": {
        "type": "ANNOUNCEMENT",
        "msgTemplate": ${_includes.announcement_self},
      },
      "preconditionExpr": """user.studies["cmi-pancan"].forms["CONSENT"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "USER_REGISTERED"
      },
      "action": {
        "type": "ANNOUNCEMENT",
        "msgTemplate": ${_includes.announcement_child},
      },
      "preconditionExpr": """!user.studies["cmi-pancan"].forms["CONSENT"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },

    # When consent created
    ## Queue up 1 week reminders
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.consent},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT"].isStatus("COMPLETE")
        || user.studies["cmi-pancan"].hasAgedUp()""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.parental},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.parental},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT_PARENTAL"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.assent},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.assent},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT_ASSENT"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.colorectal_consent},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_colorectal_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_colorectal_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.colorectal_consent},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["COLORECTAL_CONSENT"].isStatus("COMPLETE")
        || user.studies["cmi-pancan"].hasAgedUp()""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.colorectal_consent_parental},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_colorectal_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_colorectal_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.colorectal_consent_parental},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["COLORECTAL_CONSENT_PARENTAL"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.colorectal_consent_assent},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_colorectal_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_colorectal_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.colorectal_consent_assent},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["COLORECTAL_CONSENT_ASSENT"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    ## Queue up 2 week reminders
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.consent},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT"].isStatus("COMPLETE")
        || user.studies["cmi-pancan"].hasAgedUp()""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.parental},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.parental},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT_PARENTAL"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.assent},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.assent},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT_ASSENT"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.colorectal_consent},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_colorectal_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_colorectal_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.colorectal_consent},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["COLORECTAL_CONSENT"].isStatus("COMPLETE")
        || user.studies["cmi-pancan"].hasAgedUp()""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.colorectal_consent_parental},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_colorectal_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_colorectal_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.colorectal_consent_parental},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["COLORECTAL_CONSENT_PARENTAL"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.colorectal_consent_assent},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_colorectal_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_colorectal_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.colorectal_consent_assent},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["COLORECTAL_CONSENT_ASSENT"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # When consent submitted
    ## Copy answers to profile
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "COPY_ANSWER",
        "copyConfigPairs": [
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.consent_firstname} },
            "target": { "type": "PARTICIPANT_PROFILE_FIRST_NAME" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.consent_lastname} },
            "target": { "type": "PARTICIPANT_PROFILE_LAST_NAME" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.consent_dob} },
            "target": { "type": "PARTICIPANT_PROFILE_BIRTH_DATE" }
          }
        ]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.parental},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "COPY_ANSWER",
        "copyConfigPairs": [
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.parental_child_firstname} },
            "target": { "type": "PARTICIPANT_PROFILE_FIRST_NAME" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.parental_child_lastname} },
            "target": { "type": "PARTICIPANT_PROFILE_LAST_NAME" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.parental_child_dob} },
            "target": { "type": "PARTICIPANT_PROFILE_BIRTH_DATE" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.parental_firstname} },
            "target": { "type": "OPERATOR_PROFILE_FIRST_NAME" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.parental_lastname} },
            "target": { "type": "OPERATOR_PROFILE_LAST_NAME" }
          }
        ]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.assent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "COPY_ANSWER",
        "copyConfigPairs": [
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.assent_child_firstname} },
            "target": { "type": "PARTICIPANT_PROFILE_FIRST_NAME" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.assent_child_lastname} },
            "target": { "type": "PARTICIPANT_PROFILE_LAST_NAME" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.assent_child_dob} },
            "target": { "type": "PARTICIPANT_PROFILE_BIRTH_DATE" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.assent_firstname} },
            "target": { "type": "OPERATOR_PROFILE_FIRST_NAME" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.assent_lastname} },
            "target": { "type": "OPERATOR_PROFILE_LAST_NAME" }
          }
        ]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },
    ## Create colorectal consent activity
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.colorectal_consent}
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2,
      "preconditionExpr": ${_pex.has_colorectal},
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.parental},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.colorectal_consent_parental}
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2,
      "preconditionExpr": ${_pex.has_colorectal} "||" ${_pex.addchild_has_colorectal},
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.assent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.colorectal_consent_assent}
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2,
      "preconditionExpr": ${_pex.has_colorectal} "||" ${_pex.addchild_has_colorectal},
    },

    ## Create release activity
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.release}
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.parental},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.release_minor}
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.assent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.release_minor}
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    ## Queue up completed email
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentCompleted}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentCompleted}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release},
        "pdfAttachments": [
           { "pdfName": "countmein-consent" }
        ]
      },
      "cancelExpr": """user.studies["cmi-pancan"].hasAgedUp()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.colorectal_consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_colorectal_consentCompleted}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_colorectal_consentCompleted}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release},
        "pdfAttachments": [
          { "pdfName": "countmein-colorectal-consent" }
        ]
      },
      "cancelExpr": """user.studies["cmi-pancan"].hasAgedUp()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.parental},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentCompleted}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentCompleted}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release_minor},
        "pdfAttachments": [
           { "pdfName": "countmein-consent-parental" }
        ]
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.colorectal_consent_parental},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_colorectal_consentCompleted}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_colorectal_consentCompleted}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release_minor},
        "pdfAttachments": [
          { "pdfName": "countmein-colorectal-consent-parental" }
        ]
      },
      "cancelExpr": """user.studies["cmi-pancan"].hasAgedUp()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.assent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentCompleted}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentCompleted}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release_minor},
        "pdfAttachments": [
          { "pdfName": "countmein-consent-assent" }
        ]
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.colorectal_consent_assent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_colorectal_consentCompleted}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_colorectal_consentCompleted}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release_minor},
        "pdfAttachments": [
          { "pdfName": "countmein-colorectal-consent-assent" }
        ]
      },
      "cancelExpr": """user.studies["cmi-pancan"].hasAgedUp()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    ## Mark user status as enrolled
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "USER_ENROLLED"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 4
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.parental},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "USER_ENROLLED"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 4
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.assent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "USER_ENROLLED"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 4
    },
    ## In age-up flow, queue up reconsent thank you email
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_reconsentThankYou}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_reconsentThankYou}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": [
           { "pdfName": "countmein-consent" }
        ]
      },
      "cancelExpr": """!user.studies["cmi-pancan"].hasAgedUp()""",
      "dispatchToHousekeeping": true,
      "order": 5
    },
    ## In age-up flow, hide the child-release
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "HIDE_ACTIVITIES",
        "activityCodes": [${id.act.release_minor}],
      },
      "cancelExpr": """!user.studies["cmi-pancan"].forms["RELEASE_MINOR"].hasInstance()""",
      "dispatchToHousekeeping": false,
      "order": 6
    },

    # When release created
    ## Queue up 1 week reminders
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_releaseReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_releaseReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["RELEASE"].isStatus("COMPLETE")
        || user.studies["cmi-pancan"].hasAgedUp()""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_releaseReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_releaseReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release_minor},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["RELEASE_MINOR"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    ## Queue up 2 week reminders
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_releaseReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_releaseReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["RELEASE"].isStatus("COMPLETE")
        || user.studies["cmi-pancan"].hasAgedUp()""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_releaseReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_releaseReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release_minor},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["RELEASE_MINOR"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 2
    },

    # When release submitted
    ## Create about-cancer instances based on cancer selections from prequal or add-child
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.about_cancer},
        "createFromAnswer": true,
        "sourceQuestionStableId": ${id.q.primary_cancer_list_self},
        "targetQuestionStableId": ${id.q.diagnosis_type}
      },
      # If there's already about-cancer instances, then don't create any more.
      # Only way to get release is through prequal normal registration, so no need to check add-child.
      "preconditionExpr": """!user.studies["cmi-pancan"].forms["ABOUT_CANCER"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.about_cancer},
        "createFromAnswer": true,
        "sourceQuestionStableId": ${id.q.primary_cancer_list_child},
        "targetQuestionStableId": ${id.q.diagnosis_type}
      },
      # If there's already about-cancer instances, then don't create any more.
      "preconditionExpr": ${_pex.has_prequal}"""&& !user.studies["cmi-pancan"].forms["ABOUT_CANCER"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.about_cancer},
        "createFromAnswer": true,
        "sourceQuestionStableId": ${id.q.primary_cancer_list_add_child},
        "targetQuestionStableId": ${id.q.diagnosis_type}
      },
      # If there's already about-cancer instances, then don't create any more.
      "preconditionExpr": ${_pex.has_addchild}"""&& !user.studies["cmi-pancan"].forms["ABOUT_CANCER"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    ## Create about-you so it's available in case participant doesn't finish all of the about-cancer ones
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.about_you}
      },
      "preconditionExpr": """!user.studies["cmi-pancan"].forms["ABOUT_YOU"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.about_you}
      },
      "preconditionExpr": """!user.studies["cmi-pancan"].forms["ABOUT_YOU"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },

    ## Queue up completed email
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_releaseCompleted}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_releaseCompleted}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].hasAgedUp()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_releaseCompleted}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_releaseCompleted}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 3
    },
    ## Queue up 1 week survey reminders (since this email looks at both about-cancer and about-you, we create it here after release)
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_surveyReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_surveyReminder}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      # todo: we should look at all instances of about-cancer and not just latest one
      "cancelExpr": """user.studies["cmi-pancan"].forms["ABOUT_CANCER"].isStatus("COMPLETE")
        && user.studies["cmi-pancan"].forms["ABOUT_YOU"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 4
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_surveyReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_surveyReminder}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["ABOUT_CANCER"].isStatus("COMPLETE")
        && user.studies["cmi-pancan"].forms["ABOUT_YOU"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 4
    },
    ## Queue up 2 week survey reminders
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_surveyReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_surveyReminder}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["ABOUT_CANCER"].isStatus("COMPLETE")
        && user.studies["cmi-pancan"].forms["ABOUT_YOU"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 5
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_surveyReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_surveyReminder}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["ABOUT_CANCER"].isStatus("COMPLETE")
        && user.studies["cmi-pancan"].forms["ABOUT_YOU"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 5
    },

    # reconsent flow
    ## When preparing for age-up, collect child contact email
    {
      "trigger": {
        "type": "REACHED_AOM_PREP",
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.child_contact}
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    ## When child-contact created, send email to proxy
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.child_contact},
        "statusType": "CREATED"
      }
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_reconsentChildContact}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_reconsentChildContact}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.child_contact},
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    ## Queue up 1 week reminder for child-contact
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.child_contact},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_reconsentChildContactReminder1wk}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_reconsentChildContactReminder1wk}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": "CHILD_CONTACT",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CHILD_CONTACT"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 2
    },
    ## Queue up 2 week reminder for child-contact
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.child_contact},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_reconsentChildContactReminder2wk}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_reconsentChildContactReminder2wk}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": "CHILD_CONTACT",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CHILD_CONTACT"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 3
    },
    ## When child-contact completed, create the age-up invitation
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.child_contact},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "CREATE_INVITATION",
        "markExistingAsVoided": true,
        "contactEmailQuestionStableId": ${id.q.child_contact_email}
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },
    ## When age-up invitation created, send verification email to child
    {
      "trigger": {
        "type": "INVITATION_CREATED"
      },
      "action": {
        "type": "INVITATION_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_reconsentEmailVerification}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_reconsentEmailVerification}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      # If invitation is created after child participant reached AOM,
      # then skip verification email since we'll send out the next-steps emails.
      "cancelExpr": """user.studies["cmi-pancan"].hasAgedUp()""",
      "dispatchToHousekeeping": true,
      "order": 1
    },
    ## When consent status is suspended on age-up, make parental activities read-only
    {
      "trigger": {
        "type": "CONSENT_SUSPENDED"
      },
      "action": {
        "type": "MARK_ACTIVITIES_READ_ONLY",
        "activityCodes": [${id.act.parental}, ${id.act.assent}, ${id.act.release_minor}]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "GOVERNED_USER_REGISTERED"
      },
      "action": {
        "type": "HIDE_ACTIVITIES",
        "activityCodes": [${id.act.release_minor}],
      },
      "preconditionExpr": """user.studies["cmi-pancan"].forms["RELEASE_MINOR"].hasInstance() &&
      !user.studies["cmi-pancan"].forms["RELEASE_MINOR"].isStatus("COMPLETE")""",
      "dispatchToHousekeeping": false,
      "order": 5
    },
    {
      "trigger": {
        "type": "GOVERNED_USER_REGISTERED"
      },
      "action": {
        "type": "HIDE_ACTIVITIES",
        "activityCodes": [${id.act.colorectal_consent_parental}],
      },
      "preconditionExpr": """user.studies["cmi-pancan"].forms["COLORECTAL_CONSENT_PARENTAL"].hasInstance() &&
      !user.studies["cmi-pancan"].forms["COLORECTAL_CONSENT_PARENTAL"].isStatus("COMPLETE")""",
      "dispatchToHousekeeping": false,
      "order": 6
    },
    {
      "trigger": {
        "type": "GOVERNED_USER_REGISTERED"
      },
      "action": {
        "type": "HIDE_ACTIVITIES",
        "activityCodes": [${id.act.colorectal_consent_assent}],
      },
      "preconditionExpr": """user.studies["cmi-pancan"].forms["COLORECTAL_CONSENT_ASSENT"].hasInstance() &&
      !user.studies["cmi-pancan"].forms["COLORECTAL_CONSENT_ASSENT"].isStatus("COMPLETE")""",
      "dispatchToHousekeeping": false,
      "order": 7
    },

    ## When age-up occurs, send invitation to child
    {
      "trigger": {
        "type": "REACHED_AOM"
      },
      "action": {
        "type": "INVITATION_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_reconsentNextSteps}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_reconsentNextSteps}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    ## Queue up 1 week reminder for next steps email
    {
      "trigger": {
        "type": "REACHED_AOM"
      },
      "action": {
        "type": "INVITATION_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_reconsentNextStepsReminder1wk}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_reconsentNextStepsReminder1wk}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT"].hasInstance()
        && user.studies["cmi-pancan"].forms["CONSENT"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 2
    },
    ## Queue up 2 week reminder for next steps email
    {
      "trigger": {
        "type": "REACHED_AOM"
      },
      "action": {
        "type": "INVITATION_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_reconsentNextStepsReminder2wk}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_reconsentNextStepsReminder2wk}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT"].hasInstance()
        && user.studies["cmi-pancan"].forms["CONSENT"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 3
    },
    ## When child registers, create the self consent
    {
      "trigger": {
        "type": "GOVERNED_USER_REGISTERED"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.consent}
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },
    ## Then, hide the child-contact activity
    {
      "trigger": {
        "type": "GOVERNED_USER_REGISTERED"
      },
      "action": {
        "type": "HIDE_ACTIVITIES",
        "activityCodes": [${id.act.child_contact}]
      },
      "dispatchToHousekeeping": false,
      "order": 2
    },
    ## Then, setup a dashboard message for proxy
    {
      "trigger": {
        "type": "GOVERNED_USER_REGISTERED",
      },
      "action": {
        "type": "ANNOUNCEMENT",
        # Proxy might have other children and they can add more, so it should not be a permanent message.
        "permanent": false,
        "createForProxies": true,
        "msgTemplate": ${_includes.announcement_proxy},
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 3
    },
    ## Lastly, disable proxy access
    {
      "trigger": {
        "type": "GOVERNED_USER_REGISTERED"
      },
      "action": {
        "type": "REVOKE_PROXIES"
      },
      "dispatchToHousekeeping": false,
      # Order here is important. Since announcement `createForProxies` only create for active proxies,
      # we should queue up announcement before inactivating proxy.
      "order": 4
    },

    # When DSM notifications received
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "SALIVA_RECEIVED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_salivaReceived}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_salivaReceived}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "BLOOD_SENT"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_bloodSent}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_bloodSent}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "BLOOD_SENT_4WK"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_bloodReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_bloodReminder}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "BLOOD_RECEIVED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_bloodReceived}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_bloodReceived}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # pdf generation event for release pdfs
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release}
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "PDF_GENERATION",
        "pdfName": "countmein-release"
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor}
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "PDF_GENERATION",
        "pdfName": "countmein-release-parental"
      },
      "cancelExpr": """
        ! (user.studies["cmi-pancan"].forms["CONSENT_PARENTAL"].hasInstance()
        && user.studies["cmi-pancan"].forms["RELEASE_MINOR"].hasInstance()
        && user.studies["cmi-pancan"].forms["CONSENT_PARENTAL"].isStatus("COMPLETE")
        && user.studies["cmi-pancan"].forms["RELEASE_MINOR"].isStatus("COMPLETE"))
      """,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor}
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "PDF_GENERATION",
        "pdfName": "countmein-release-assent"
      },
      "cancelExpr": """
        ! (user.studies["cmi-pancan"].forms["CONSENT_ASSENT"].hasInstance()
        && user.studies["cmi-pancan"].forms["RELEASE_MINOR"].hasInstance()
        && user.studies["cmi-pancan"].forms["CONSENT_ASSENT"].isStatus("COMPLETE")
        && user.studies["cmi-pancan"].forms["RELEASE_MINOR"].isStatus("COMPLETE"))
      """,
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # medical update event for release pdfs
    {
      "trigger": {
        "type": "MEDICAL_UPDATE"
      },
      "action": {
        "type": "PDF_GENERATION",
        "pdfName": "countmein-release"
      },
      "cancelExpr": """!(user.studies["cmi-pancan"].forms["RELEASE"].hasInstance()
            && user.studies["cmi-pancan"].forms["RELEASE"].isStatus("COMPLETE"))"""
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "MEDICAL_UPDATE"
      },
      "action": {
        "type": "PDF_GENERATION",
        "pdfName": "countmein-release-parental"
      },
      "cancelExpr": """
        ! (user.studies["cmi-pancan"].forms["CONSENT_PARENTAL"].hasInstance()
        && user.studies["cmi-pancan"].forms["RELEASE_MINOR"].hasInstance()
        && user.studies["cmi-pancan"].forms["CONSENT_PARENTAL"].isStatus("COMPLETE")
        && user.studies["cmi-pancan"].forms["RELEASE_MINOR"].isStatus("COMPLETE"))
      """,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "MEDICAL_UPDATE"
      },
      "action": {
        "type": "PDF_GENERATION",
        "pdfName": "countmein-release-assent"
      },
      "cancelExpr": """
        ! (user.studies["cmi-pancan"].forms["CONSENT_ASSENT"].hasInstance()
        && user.studies["cmi-pancan"].forms["RELEASE_MINOR"].hasInstance()
        && user.studies["cmi-pancan"].forms["CONSENT_ASSENT"].isStatus("COMPLETE")
        && user.studies["cmi-pancan"].forms["RELEASE_MINOR"].isStatus("COMPLETE"))
      """,
      "dispatchToHousekeeping": true,
      "order": 1
    }

    # blood kits email events
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.blood_consent},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          {
            "emailTemplate": ${emails.en_blood_consent_created},
            "language": "en",
            "isDynamic": true
          }
        ],
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.blood_consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          {
            "emailTemplate": ${emails.en_blood_consent_completed},
            "language": "en",
            "isDynamic": true
          }
        ],
        "pdfAttachments": [
          {"pdfName": "cmiproject-blood-consent", "generateIfMissing": true}
        ]
      },
      "dispatchToHousekeeping": true,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.family_history},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_familyHistory_created}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_familyHistory_created}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["FAMILY_HISTORY"].isStatus("COMPLETE")"""
      "delaySeconds": null,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.family_history},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_familyHistory_surveyReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_familyHistory_surveyReminder}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["FAMILY_HISTORY"].isStatus("COMPLETE")"""
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.family_history},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_familyHistory_surveyReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_familyHistory_surveyReminder}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["FAMILY_HISTORY"].isStatus("COMPLETE")"""
      "delaySeconds": ${timeout.secs_3_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.family_history},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_familyHistory_surveyReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_familyHistory_surveyReminder}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["FAMILY_HISTORY"].isStatus("COMPLETE")"""
      "delaySeconds": ${timeout.secs_4_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.diet_lifestyle},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_diet_created}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_diet_created}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["DIET_LIFESTYLE"].isStatus("COMPLETE")"""
      "delaySeconds": null,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.diet_lifestyle},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_diet_surveyReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_diet_surveyReminder}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["DIET_LIFESTYLE"].isStatus("COMPLETE")"""
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.diet_lifestyle},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_diet_surveyReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_diet_surveyReminder}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["DIET_LIFESTYLE"].isStatus("COMPLETE")"""
      "delaySeconds": ${timeout.secs_4_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.diet_lifestyle},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_diet_surveyReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_diet_surveyReminder}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["DIET_LIFESTYLE"].isStatus("COMPLETE")"""
      "delaySeconds": ${timeout.secs_5_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "STOOL_SENT"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_stoolkit_surveyReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_stoolkit_surveyReminder}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "delaySeconds": null,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.family_history},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_familyHistory_complete}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_familyHistory_complete}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "delaySeconds": null,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.diet_lifestyle},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_diet_complete}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_diet_complete}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "delaySeconds": null,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.stool_kit},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_stoolkit_complete}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_stoolkit_complete}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "delaySeconds": null,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.stool_kit}
      },
      "preconditionExpr": ${_pex.has_colorectal}"""&& !user.studies["cmi-pancan"].forms["STOOL_KIT"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.stool_kit}
      },
      "preconditionExpr": """(user.studies["cmi-pancan"].forms["PREQUAL"].hasInstance() && user.studies["cmi-pancan"].forms["PREQUAL"].questions["PRIMARY_CANCER_LIST_CHILD"].isAnswered() && user.studies["cmi-pancan"].forms["PREQUAL"].questions["PRIMARY_CANCER_LIST_CHILD"].children["PRIMARY_CANCER_CHILD"].answers.hasOptionStartsWith("C_GASTRO_CRC_COLORECTAL", "C_GASTRO_COLON_CANCER", "C_GASTRO_RECTAL_CANCER") || (user.studies["cmi-pancan"].forms["ADD_CHILD"].hasInstance() && user.studies["cmi-pancan"].forms["ADD_CHILD"].questions["PRIMARY_CANCER_LIST_ADD_CHILD"].children["PRIMARY_CANCER_ADD_CHILD"].answers.hasOptionStartsWith("C_GASTRO_CRC_COLORECTAL", "C_GASTRO_COLON_CANCER", "C_GASTRO_RECTAL_CANCER"))) && !user.studies["cmi-pancan"].forms["STOOL_KIT"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "STOOL_SENT"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "STOOL_KIT"
      },
      "preconditionExpr": "("${_pex.has_colorectal}"||"${_pex.addchild_has_colorectal}""")&& !user.studies["cmi-pancan"].forms["STOOL_KIT"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
  ]
}
