{
  "events": [
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ADDENDUM",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.enConsentAddendum},
        "language": "en",
        "pdfAttachments": [
          { "pdfName": "osproject-consent-addendum", "generateIfMissing": true }
        ]
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ADDENDUM_PEDIATRIC",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.enParentalConsentAddendum},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ADDENDUM_PEDIATRIC",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.ParentalConsentAddendumReceived},
        "language": "en",
        "pdfAttachments": []
      },
      "delaySeconds": ${delay.weeks.two},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ADDENDUM",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.ConsentAddendumReceived},
        "language": "en",
        "pdfAttachments": []
      },
      "delaySeconds": ${delay.weeks.two},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "GERMLINE_CONSENT_ADDENDUM",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.GermlineAddendumReceived},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "GERMLINE_CONSENT_ADDENDUM",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.GermlineAddendumComplete},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "GERMLINE_CONSENT_ADDENDUM_PEDIATRIC",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.ParentalGermlineAddendumReceived},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "GERMLINE_CONSENT_ADDENDUM_PEDIATRIC",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.ParentalGermlineAddendumRequired},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "GERMLINE_CONSENT_ADDENDUM",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.GermlineAddendumRequired},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "GERMLINE_CONSENT_ADDENDUM_PEDIATRIC",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.ParentalGermlineAddendumComplete},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "FAMILY_HISTORY_SELF",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.familyHistoryReminder},
        "language": "en",
        "pdfAttachments": []
      },
      "delaySeconds": ${delay.weeks.two},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "FAMILY_HISTORY_PARENTAL",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.familyHistoryReminderParental},
        "language": "en",
        "pdfAttachments": []
      },
      "delaySeconds": ${delay.weeks.two},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "REACHED_AOM"
      },
      "action": {
        "type": "INVITATION_EMAIL",
        "emailTemplate": ${emails.reconsentEmailVerification},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "SALIVA_RECEIVED"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "GERMLINE_CONSENT_ADDENDUM"
      },
      "preconditionExpr": """user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasAnyOption("US", "PR", "GU", "VI", "MP", "AS")
                            && user.studies["CMI-OSTEO"].forms["RELEASE_SELF"].isStatus("COMPLETE")""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "SALIVA_RECEIVED"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "GERMLINE_CONSENT_ADDENDUM_PEDIATRIC"
      },
      "preconditionExpr": """user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasAnyOption("US", "PR", "GU", "VI", "MP", "AS")
                            && user.studies["CMI-OSTEO"].forms["RELEASE_MINOR"].isStatus("COMPLETE")""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "UPDATE_CUSTOM_WORKFLOW",
        "workflow": "OSTEO_RECONSENTED",
        "status": "Complete"
      },
      "preconditionExpr": """user.studies["CMI-OSTEO"].forms["CONSENT"].instances[latest].hasPreviousInstance()"""
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ASSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "UPDATE_CUSTOM_WORKFLOW",
        "workflow": "OSTEO_RECONSENTED",
        "status": "Complete"
      },
      "preconditionExpr": """user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].instances[latest].hasPreviousInstance()"""
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PARENTAL_CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "UPDATE_CUSTOM_WORKFLOW",
        "workflow": "OSTEO_RECONSENTED",
        "status": "Complete"
      },
      "preconditionExpr": """user.studies["CMI-OSTEO"].forms["PARENTAL_CONSENT"].instances[latest].hasPreviousInstance()"""
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "ABOUTYOU",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "ABOUT_YOU_ACTIVITY"
      },
      "preconditionExpr": """!user.studies["CMI-OSTEO"].forms["ABOUT_YOU_ACTIVITY"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "ABOUTCHILD",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "ABOUT_CHILD_ACTIVITY"
      },
      "preconditionExpr": """!user.studies["CMI-OSTEO"].forms["ABOUT_CHILD_ACTIVITY"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "CONSENT_ADDENDUM"
      },
      "preconditionExpr": """
        !(
            user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("CA")
            || user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_STATE"].answers.hasOption("NY")
            || user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("CA")
            || user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_STATE"].answers.hasOption("NY")
        )
        &&
        user.studies["CMI-OSTEO"].forms["CONSENT"].questions["CONSENT_TISSUE"].answers.hasTrue()
      """
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ASSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "CONSENT_ADDENDUM_PEDIATRIC"
      },
      "preconditionExpr": """!(user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("CA") ||
                   user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_STATE"].answers.hasOption("NY")) &&
                   user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].questions["CONSENT_ASSENT_TISSUE"].answers.hasTrue()"""
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PARENTAL_CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "CONSENT_ADDENDUM_PEDIATRIC"
      },
      "preconditionExpr": """!(user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("CA") ||
                   user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_STATE"].answers.hasOption("NY")) &&
                   user.studies["CMI-OSTEO"].forms["PARENTAL_CONSENT"].questions["PARENTAL_CONSENT_TISSUE"].answers.hasTrue()"""
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    ## CONSENT TO RELEASE
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ADDENDUM",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "RELEASE_SELF"
      },
      "maxOccurrencesPerUser": 1,
      "preconditionExpr": """!user.studies["CMI-OSTEO"].forms["RELEASE_SELF"].hasInstance()""",
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ADDENDUM_PEDIATRIC",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "RELEASE_MINOR"
      },
      "maxOccurrencesPerUser": 1,
      "preconditionExpr": """!user.studies["CMI-OSTEO"].forms["RELEASE_MINOR"].hasInstance()""",
      "dispatchToHousekeeping": false,
      "order": 1
    },
    # announcement events
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "LOVEDONE",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ANNOUNCEMENT",
        "msgTemplate": { include required("../snippets/loved-one-announcement-msg.conf") }
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    }
  ]
}
