{
  "activities": [
    {
      "filepath": "activities/prequal.conf",
      "mappings": [],
      "validations": [
        {
          "stableIds": ["PREQUAL_AGE"],
          "precondition": """
            operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_AGE"].isAnswered()
            && operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].isAnswered()
          """,
          "expression": """
            ( operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasOption("US")
              && (
                ( operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_STATE"].answers.hasAnyOption("AL", "NE")
                  && operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_AGE"].answers.value() < 19
                ) || (
                  operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_STATE"].answers.hasAnyOption("MS")
                  && operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_AGE"].answers.value() < 21
                ) || (
                  !operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_STATE"].answers.hasAnyOption("MS", "AL", "NE")
                  && operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_AGE"].answers.value() < 18
                )
              )
            ) || (
              operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasOption("CA")
              && (
                ( operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_PROVINCE"].answers.hasAnyOption("BC", "NB", "NL", "NT", "NS", "NU", "YT")
                  && operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_AGE"].answers.value() < 19
                ) || (
                  operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_PROVINCE"].answers.hasAnyOption("AB", "MB", "ON", "PE", "QC", "SK")
                  && operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_AGE"].answers.value() < 18
                )
              )
            ) || (
              operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasOption("PR")
              && operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_AGE"].answers.value() < 21
            ) || (
              operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasAnyOption("GU", "VI", "MP", "AS")
              && operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_AGE"].answers.value() < 18
            )
          """,
          "messageTemplate": {
            "templateType": "HTML",
            "templateText": "$prequal_age_restriction_hint",
            "variables": [
              {
                "name": "prequal_age_restriction_hint",
                "translations": [
                  { "language": "en", "text": ${i18n.en.prequal.age.restriction_hint} }
                ]
              }
            ]
          }
        },
        {
          "stableIds": ["PREQUAL_COUNTRY"],
          "precondition": """
            operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].isAnswered()
          """,
          "expression": """
            !operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasAnyOption("US", "CA", "PR", "GU", "VI", "MP", "AS")
          """,
          "messageTemplate": {
            "templateType": "TEXT",
            "templateText": "$prequal_country_ineligible_hint",
            "variables": [
              {
                "name": "prequal_country_ineligible_hint",
                "translations": [
                  { "language": "en", "text": ${i18n.en.prequal.country.ineligible_hint} }
                ]
              }
            ]
          }
        },
        {
          "stableIds": ["PREQUAL_DIAGNOSED"],
          "precondition": """
            operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_DIAGNOSED"].isAnswered()
          """,
          "expression": """
            operator.studies["singular"].forms["PREQUAL"].questions["PREQUAL_DIAGNOSED"].answers.hasFalse()
          """,
          "messageTemplate": {
            "templateType": "TEXT",
            "templateText": "$prequal_diagnosed_ineligible_hint",
            "variables": [
              {
                "name": "prequal_diagnosed_ineligible_hint",
                "translations": [
                  { "language": "en", "text": ${i18n.en.prequal.diagnosed.ineligible_hint} }
                ]
              }
            ]
          }
        }
      ]
    },
    {
      "filepath": "activities/add-participant-parental.conf",
      "mappings": [],
      "validations": [
        {
          "stableIds": ["ENROLLING_CHILD_DIAGNOSED"],
          "precondition": """
            user.studies["singular"].forms["ADD_PARTICIPANT_PARENTAL"].questions["ENROLLING_CHILD_DIAGNOSED"].isAnswered()
          """,
          "expression": """
            user.studies["singular"].forms["ADD_PARTICIPANT_PARENTAL"].questions["ENROLLING_CHILD_DIAGNOSED"].answers.hasOption("SOMEONE")
          """,
          "messageTemplate": {
            "templateType": "TEXT",
            "templateText": "$add_participant_enrolling_child_diagnosed_ineligible_hint",
            "variables": [
              {
                "name": "add_participant_enrolling_child_diagnosed_ineligible_hint",
                "translations": [
                  { "language": "en", "text": ${i18n.en.add_participant.enrolling_child_diagnosed.ineligible_hint} }
                ]
              }
            ]
          }
        },
        {
          "stableIds": ["ENROLLING_CHILD_AGE"],
          "precondition": """
            user.studies["singular"].forms["ADD_PARTICIPANT_PARENTAL"].questions["ENROLLING_CHILD_AGE"].isAnswered()
            && user.studies["singular"].forms["ADD_PARTICIPANT_PARENTAL"].questions["ADD_PARTICIPANT_INCAPACITATED"].isAnswered()
            && user.studies["singular"].forms["ADD_PARTICIPANT_PARENTAL"].questions["ADD_PARTICIPANT_INCAPACITATED"].answers.hasFalse()
          """,
          "expression": ${_pex.age_of_majority.child},
          "messageTemplate": {
            "templateType": "HTML",
            "templateText": "$add_participant_enrolling_child_age_restriction_hint",
            "variables": [
              {
                "name": "add_participant_enrolling_child_age_restriction_hint",
                "translations": [
                  { "language": "en", "text": ${i18n.en.add_participant.enrolling_child_age.restriction_hint} }
                ]
              }
            ]
          }
        }
      ]
    },
    {
      "filepath": "activities/add-participant-dependent.conf",
      "mappings": [],
      "validations": [
        {
          "stableIds": ["ENROLLING_DEPENDENT_DIAGNOSED"],
          "precondition": """
            user.studies["singular"].forms["ADD_PARTICIPANT_DEPENDENT"].questions["ENROLLING_DEPENDENT_DIAGNOSED"].isAnswered()
          """,
          "expression": """
            user.studies["singular"].forms["ADD_PARTICIPANT_DEPENDENT"].questions["ENROLLING_DEPENDENT_DIAGNOSED"].answers.hasOption("SOMEONE")
          """,
          "messageTemplate": {
            "templateType": "TEXT",
            "templateText": "$add_participant_enrolling_dependent_diagnosed_ineligible_hint",
            "variables": [
              {
                "name": "add_participant_enrolling_dependent_diagnosed_ineligible_hint",
                "translations": [
                  { "language": "en", "text": ${i18n.en.add_participant.enrolling_dependent_diagnosed.ineligible_hint} }
                ]
              }
            ]
          }
        },
        {
          "stableIds": ["ENROLLING_DEPENDENT_AGE"],
          "precondition": """
            user.studies["singular"].forms["ADD_PARTICIPANT_DEPENDENT"].questions["ENROLLING_DEPENDENT_AGE"].isAnswered()
            && user.studies["singular"].forms["ADD_PARTICIPANT_DEPENDENT"].questions["ADD_PARTICIPANT_INCAPACITATED_DEPENDENT"].isAnswered()
            && user.studies["singular"].forms["ADD_PARTICIPANT_DEPENDENT"].questions["ADD_PARTICIPANT_INCAPACITATED_DEPENDENT"].answers.hasFalse()
          """,
          "expression": ${_pex.age_of_majority.dependent},
          "messageTemplate": {
            "templateType": "HTML",
            "templateText": "$add_participant_enrolling_dependent_age_restriction_hint",
            "variables": [
              {
                "name": "add_participant_enrolling_dependent_age_restriction_hint",
                "translations": [
                  { "language": "en", "text": ${i18n.en.add_participant.enrolling_dependent_age.restriction_hint} }
                ]
              }
            ]
          }
        }
      ]
    },
    {
      "filepath": "activities/add-participant-self.conf",
      "mappings": [],
      "validations": [
        {
          "stableIds": ["ENROLLING_MYSELF_DIAGNOSED"],
          "precondition": """
            user.studies["singular"].forms["ADD_PARTICIPANT_SELF"].questions["ENROLLING_MYSELF_DIAGNOSED"].isAnswered()
          """,
          "expression": """
            user.studies["singular"].forms["ADD_PARTICIPANT_SELF"].questions["ENROLLING_MYSELF_DIAGNOSED"].answers.hasOption("SOMEONE")
          """,
          "messageTemplate": {
            "templateType": "TEXT",
            "templateText": "$add_participant_enrolling_myself_diagnosed_ineligible_hint",
            "variables": [
              {
                "name": "add_participant_enrolling_myself_diagnosed_ineligible_hint",
                "translations": [
                  { "language": "en", "text": ${i18n.en.add_participant.enrolling_myself_diagnosed.ineligible_hint} }
                ]
              }
            ]
          }
        }
      ]
    },
    {
      "filepath": "activities/consent-self.conf",
      "mappings": [],
      "validations": []
    },
    {
      "filepath": "activities/consent-assent.conf",
      "mappings": [],
      "validations": []
    },
    {
      "filepath": "activities/consent-parental.conf",
      "mappings": [],
      "validations": [

        # When using the Enroll Child flow, if a user enters an age between >=7 years and AOM for their region
        # and answers NO to cognitive-impairment in the pre-qual but enters a date of birth that equates to <7 years
        # in the child consent, an error message should appear under the consent DOB field
        # Formally: PREQUAL.AGE >= 7 && PREQUAL.AGE < AOM && !PREQUAL.CAPABLE && CONSENT.DOB < 7
        {
          "messageTemplate": {
            "templateType": "HTML",
            "templateText": "$singular_consent_parental_validation_case1",
            "variables": [
              {
                "name": "singular_consent_parental_validation_case1",
                "translations": [
                  {
                    "language": "en",
                    "text": """Please check the date of birth you entered for your child. If the date is correct,
                               then your child does not need to give their own assent to participate in the study.
                               In that case, please return to the dashboard and click "Enroll my child" to begin a
                               new enrollment for your child, or contact us for help at (650) 561-6750 or
                               <a href="mailto:contact@projectsingular.org">contact@projectsingular.org</a>.
                            """
                  }
                ]
              }
            ]
          },
          "stableIds": ["CONSENT_PARENTAL_CHILD_DATE_OF_BIRTH, ENROLLING_CHILD_AGE, ADD_PARTICIPANT_INCAPACITATED", "PREQUAL_COUNTRY", "PREQUAL_STATE", "PREQUAL_PROVINCE"],
          "precondition": """
                          user.studies["singular"].forms["ADD_PARTICIPANT_PARENTAL"].questions["ENROLLING_CHILD_AGE"].isAnswered()
                          &&
                          user.studies["singular"].forms["ADD_PARTICIPANT_PARENTAL"].questions["ADD_PARTICIPANT_INCAPACITATED"].isAnswered()
                          &&
                          user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].isAnswered()
                          &&
                          (
                            !user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasAnyOption("US", "CA")
                            ||
                            (
                              user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasOption("US")
                              &&
                              user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_STATE"].isAnswered()
                            )
                            ||
                            (
                              user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasOption("CA")
                              &&
                              user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_PROVINCE"].isAnswered()
                            )                          
                          )
                          """,
          "expression": """
                              (
                                user.studies["singular"].forms["ADD_PARTICIPANT_PARENTAL"].questions["ENROLLING_CHILD_AGE"].answers.value() >= 7
                                &&
                                user.studies["singular"].forms["ADD_PARTICIPANT_PARENTAL"].questions["ADD_PARTICIPANT_INCAPACITATED"].answers.hasFalse()
                                &&
                                user.studies["singular"].forms["CONSENT_PARENTAL"].questions["CONSENT_PARENTAL_CHILD_DATE_OF_BIRTH"].answers.ageAtMost(7, YEARS)
                                &&
                                !(
                                  ( user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasOption("US")
                                    && (
                                      (
                                        user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_STATE"].answers.hasOption("AL")
                                        &&
                                        user.studies["singular"].forms["PREQUAL"].questions["ENROLLING_CHILD_AGE"].answers.value() >= 19
                                      )
                                      ||
                                      (
                                        !user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_STATE"].answers.hasOption("AL")
                                        &&
                                        user.studies["singular"].forms["PREQUAL"].questions["ENROLLING_CHILD_AGE"].answers.value() >= 18
                                      )
                                    )
                                  )
                                  ||
                                  (
                                    user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasOption("CA")
                                    &&
                                    (
                                      (
                                        user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_PROVINCE"].answers.hasAnyOption("BC", "NB", "NL", "NT", "NS", "NU", "YT")
                                        &&
                                        user.studies["singular"].forms["PREQUAL"].questions["ENROLLING_CHILD_AGE"].answers.value() >= 19
                                      )
                                      ||
                                      (
                                        user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_PROVINCE"].answers.hasAnyOption("AB", "MB", "ON", "PE", "QC", "SK")
                                        &&
                                        user.studies["singular"].forms["PREQUAL"].questions["ENROLLING_CHILD_AGE"].answers.value() >= 18
                                      )
                                    )
                                  )
                                  ||
                                  (
                                    user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasOption("PR")
                                    &&
                                    user.studies["singular"].forms["PREQUAL"].questions["ENROLLING_CHILD_AGE"].answers.value() >= 21
                                  )
                                  ||
                                  (
                                    user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasAnyOption("GU", "VI", "MP", "AS")
                                    &&
                                    user.studies["singular"].forms["PREQUAL"].questions["ENROLLING_CHILD_AGE"].answers.value() >= 18
                                  )
                                )
                              )
                              """
        },

        # When using the Enroll Child flow, if a user enters an age between >=7 and AOM for their region and
        # answers NO to cognitive-impairment in the pre-qual but enters a date of birth that equates to >=AOM
        # in the child consent, an error message should appear under the consent DOB field.
        # Formally: PREQUAL.AGE >= 7 && PREQUAL.AGE < AOM && !PREQUAL.CAPABLE && CONSENT.DOB >= AOM
        {
          "messageTemplate": {
            "templateType": "HTML",
            "templateText": "$singular_consent_parental_validation_case2",
            "variables": [
              {
                "name": "singular_consent_parental_validation_case2",
                "translations": [
                  {
                    "language": "en",
                    "text": """Please check the date of birth you have entered. If the date is correct, your child
                               has reached the age of majority and must register and enroll themself. If you think
                               there is a mistake, please reach out to us at (650) 561-6750 or
                               <a href="mailto:contact@projectsingular.org">contact@projectsingular.org</a>.
                            """
                  }
                ]
              }
            ]
          },
          "stableIds": ["CONSENT_PARENTAL_CHILD_DATE_OF_BIRTH, ENROLLING_CHILD_AGE, ADD_PARTICIPANT_INCAPACITATED", "PREQUAL_COUNTRY", "PREQUAL_STATE", "PREQUAL_PROVINCE"],
          "precondition": """
                          user.studies["singular"].forms["ADD_PARTICIPANT_PARENTAL"].questions["ENROLLING_CHILD_AGE"].isAnswered()
                          &&
                          user.studies["singular"].forms["ADD_PARTICIPANT_PARENTAL"].questions["ADD_PARTICIPANT_INCAPACITATED"].isAnswered()
                          &&
                          user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].isAnswered()
                          &&
                          (
                            !user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasAnyOption("US", "CA")
                            ||
                            (
                              user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasOption("US")
                              &&
                              user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_STATE"].isAnswered()
                            )
                            ||
                            (
                              user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasOption("CA")
                              &&
                              user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_PROVINCE"].isAnswered()
                            )
                          )
                          """,
          "expression": """
                        (
                          user.studies["singular"].forms["ADD_PARTICIPANT_PARENTAL"].questions["ENROLLING_CHILD_AGE"].answers.value() >= 7
                          &&
                          user.studies["singular"].forms["ADD_PARTICIPANT_PARENTAL"].questions["ADD_PARTICIPANT_INCAPACITATED"].answers.hasFalse()
                          &&
                          !(
                            ( user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasOption("US")
                              && (
                                (
                                  user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_STATE"].answers.hasOption("AL")
                                  &&
                                  user.studies["singular"].forms["PREQUAL"].questions["ENROLLING_CHILD_AGE"].answers.value() >= 19
                                )
                                ||
                                (
                                  !user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_STATE"].answers.hasOption("AL")
                                  &&
                                  user.studies["singular"].forms["PREQUAL"].questions["ENROLLING_CHILD_AGE"].answers.value() >= 18
                                )
                              )
                            )
                            ||
                            (
                              user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasOption("CA")
                              &&
                              (
                                (
                                  user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_PROVINCE"].answers.hasAnyOption("BC", "NB", "NL", "NT", "NS", "NU", "YT")
                                  &&
                                  user.studies["singular"].forms["PREQUAL"].questions["ENROLLING_CHILD_AGE"].answers.value() >= 19
                                )
                                ||
                                (
                                  user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_PROVINCE"].answers.hasAnyOption("AB", "MB", "ON", "PE", "QC", "SK")
                                  &&
                                  user.studies["singular"].forms["PREQUAL"].questions["ENROLLING_CHILD_AGE"].answers.value() >= 18
                                )
                              )
                            )
                            ||
                            (
                              user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasOption("PR")
                              &&
                              user.studies["singular"].forms["PREQUAL"].questions["ENROLLING_CHILD_AGE"].answers.value() >= 21
                            )
                            ||
                            (
                              user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasAnyOption("GU", "VI", "MP", "AS")
                              &&
                              user.studies["singular"].forms["PREQUAL"].questions["ENROLLING_CHILD_AGE"].answers.value() >= 18
                            )
                          )
                          &&
                          (
                            ( user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasOption("US")
                              && (
                                (
                                  user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_STATE"].answers.hasOption("AL")
                                  &&
                                  user.studies["singular"].forms["CONSENT_PARENTAL"].questions["CONSENT_PARENTAL_CHILD_DATE_OF_BIRTH"].answers.ageAtLeast(19, YEARS)
                                )
                                ||
                                (
                                  !user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_STATE"].answers.hasOption("AL")
                                  &&
                                  user.studies["singular"].forms["CONSENT_PARENTAL"].questions["CONSENT_PARENTAL_CHILD_DATE_OF_BIRTH"].answers.ageAtLeast(18, YEARS)
                                )
                              )
                            )
                            ||
                            (
                              user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasOption("CA")
                              &&
                              (
                                (
                                  user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_PROVINCE"].answers.hasAnyOption("BC", "NB", "NL", "NT", "NS", "NU", "YT")
                                  &&
                                  user.studies["singular"].forms["CONSENT_PARENTAL"].questions["CONSENT_PARENTAL_CHILD_DATE_OF_BIRTH"].answers.ageAtLeast(19, YEARS)
                                )
                                ||
                                (
                                  user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_PROVINCE"].answers.hasAnyOption("AB", "MB", "ON", "PE", "QC", "SK")
                                  &&
                                  user.studies["singular"].forms["CONSENT_PARENTAL"].questions["CONSENT_PARENTAL_CHILD_DATE_OF_BIRTH"].answers.ageAtLeast(18, YEARS)
                                )
                              )
                            )
                            ||
                            (
                              user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasOption("PR")
                              &&
                              user.studies["singular"].forms["CONSENT_PARENTAL"].questions["CONSENT_PARENTAL_CHILD_DATE_OF_BIRTH"].answers.ageAtLeast(21, YEARS)
                            )
                            ||
                            (
                              user.studies["singular"].forms["PREQUAL"].questions["PREQUAL_COUNTRY"].answers.hasAnyOption("GU", "VI", "MP", "AS")
                              &&
                              user.studies["singular"].forms["CONSENT_PARENTAL"].questions["CONSENT_PARENTAL_CHILD_DATE_OF_BIRTH"].answers.ageAtLeast(18, YEARS)
                            )
                          )
                        )
                        """
        },
      ]
    },
    {
      "filepath": "activities/consent-dependent.conf",
      "mappings": [],
      "validations": []
    },
    {
      "filepath": "activities/about-healthy.conf",
      "mappings": [],
      "validations": []
    },
    {
      "filepath": "activities/about-patient.conf",
      "mappings": [],
      "validations": []
    },
    {
      "filepath": "activities/medical-record-release.conf",
      "mappings": [],
      "validations": []
    },
    {
      "filepath": "activities/medical-record-file-upload.conf",
      "mappings": [],
      "validations": []
    },
    {
      "filepath": "activities/patient-survey.conf",
      "mappings": [],
      "validations": []
    },
    {
      "filepath": "activities/child-contact.conf",
      "mappings": [],
      "validations": []
    }
  ]
}