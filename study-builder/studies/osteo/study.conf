{
  "tenant": {
    "domain": ${auth0.domain},
    "mgmtClientId": ${auth0.mgmtClientId},
    "mgmtSecret": ${auth0.mgmtSecret}
  },

  "umbrella": {
    "name": "CMI",
    "guid": "cmi"
  },

  "study": {
    "name": "osproject",
    "guid": "CMI-OSTEO",
    "studyEmail": "info@osproject.org",
    "baseWebUrl": ${baseWebUrl},
    "irbPassword": ${irbPassword},
    "plusCodePrecision": "MEDIUM",
    "shareParticipantLocation": true
  },

  "client": {
    "name": "osteo-angular-client",
    "id": ${auth0.clientId},
    "secret": ${auth0.clientSecret},
    "passwordRedirectUrl": ${passwordRedirectUrl}
  },

  "adminUser": {
    "guid": "CMIPEPPERADMINUSER"
  },

  "governance": {
    "shouldCreateGovernedUserExpr": """
      user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
      && (user.studies["CMI-OSTEO"].forms["PARENTAL_CONSENT"].hasInstance() || user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].hasInstance())
    """,
    "ageOfMajorityRules": [
      # AoM for U.S.
      {
        "condition": """
          user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
          && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("US")
          && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_STATE"].answers.hasOption("AL")
        """,
        "age": 19,
        "prepMonths": 4
      },
      {
        "condition": """
          user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
          && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("US")
          && !user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_STATE"].answers.hasOption("AL")
        """,
        "age": 18,
        "prepMonths": 4
      },

      # Aom for Puerto Rico
      {
        "condition": """
          user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
          && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("PR")
        """,
        "age": 21,
        "prepMonths": 4
      },

      # Aom for other U.S. Territories
      {
        "condition": """
          user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
          && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasAnyOption("GU", "VI", "MP", "AS")
        """,
        "age": 18,
        "prepMonths": 4
      },

      # AoM for Canada
      {
        "condition": """
          user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
          && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("CA")
          && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_PROVINCE"].answers.hasAnyOption("BC", "NB", "NL", "NT", "NS", "NU", "YT")
        """,
        "age": 19,
        "prepMonths": 4
      },
      {
        "condition": """
          user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
          && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("CA")
          && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_PROVINCE"].answers.hasAnyOption("AB", "MB", "ON", "PE", "QC", "SK")
        """,
        "age": 18,
        "prepMonths": 4
      }
    ]
  },

  "studyDetails": [],

  "supportedLanguages": [
    {
      "language": "en",
      "name" : "English",
      "isDefault" : true
    }
  ],

  "sendgrid": {
    "apiKey": ${sendgridApiKey},
    "fromName": ${sendgridFromName},
    "fromEmail": ${sendgridFromEmail},
    "defaultSalutation": ${sendgridDefaultSalutation}
  },

  include required("sendgrid_emails.conf"),

  "kits": [
    {
      "type": "SALIVA",
      "quantity": 1,
      "rules": [
        {
          "type": "PEX",
          "expression": """
            (user.studies["CMI-OSTEO"].forms["RELEASE_SELF"].hasInstance() && user.studies["CMI-OSTEO"].forms["RELEASE_SELF"].isStatus("COMPLETE"))
            || (user.studies["CMI-OSTEO"].forms["RELEASE_MINOR"].hasInstance() && user.studies["CMI-OSTEO"].forms["RELEASE_MINOR"].isStatus("COMPLETE"))
          """
        },
        {
          "type": "COUNTRY",
          "country": "us"     # United States
        },
        {
          "type": "COUNTRY",
          "country": "ca"     # Canada
        },
        {
          "type": "COUNTRY",
          "country": "pr"     # Puerto Rico
        },
        {
          "type": "COUNTRY",
          "country": "gu"     # Guam
        },
        {
          "type": "COUNTRY",
          "country": "vi"     # U.S. Virgin Islands
        },
        {
          "type": "COUNTRY",
          "country": "mp"     # Northern Mariana Islands
        },
        {
          "type": "COUNTRY",
          "country": "as"     # American Samoa
        }
      ]
    }
  ],

  "activities": [
    {
      "filepath": "prequal.conf",
      "mappings": [],
      "validations": [
        # complex validations for international patients
        {
          "messageTemplate": {
            "templateType": "HTML",
            "templateText": "$osteo_prequal_validation_self_international",
            "variables": [
              {
                "name": "osteo_prequal_validation_self_international",
                "translations": [
                  {
                    "language": "en",
                    "text": """
                      Currently, the Osteosarcoma Project is open only to patients in the United States or Canada.
                      If you do live or are treated in the United States or Canada, please reach out to us at
                      <a href="mailto:info@osproject.org" class="Link">info@osproject.org</a>.
                    """
                  }
                ]
              }
            ]
          },
          "stableIds": ["SELF_COUNTRY"],
          "precondition": """
            user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
            && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].isAnswered()
          """,
          "expression": """
            !user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasAnyOption("US", "CA", "PR", "GU", "VI", "MP", "AS")
          """
        },
        {
          "messageTemplate": {
            "templateType": "HTML",
            "templateText": "$osteo_prequal_validation_child_international",
            "variables": [
              {
                "name": "osteo_prequal_validation_child_international",
                "translations": [
                  {
                    "language": "en",
                    "text": """
                      Currently, the Osteosarcoma Project is open only to patients in the United States or Canada.
                      If your child does live or is treated in the United States or Canada, please reach out to us at
                      <a href="mailto:info@osproject.org" class="Link">info@osproject.org</a>.
                    """
                  }
                ]
              }
            ]
          },
          "stableIds": ["CHILD_COUNTRY"],
          "precondition": """
            user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
            && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].isAnswered()
          """,
          "expression": """
            !user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasAnyOption("US", "CA", "PR", "GU", "VI", "MP", "AS")
          """
        },

        # complex validation for requiring parental consent
        {
          "messageTemplate": {
            "templateType": "HTML",
            "templateText": "$osteo_prequal_validation_need_parental_consent",
            "variables": [
              {
                "name": "osteo_prequal_validation_need_parental_consent",
                "translations": [
                  {
                    "language": "en",
                    "text": """
                      <span class="bold">In order to participate in the project, a parent needs to help you.</span>
                      When your parent is with you, click back and select "My child has been diagnosed with osteosarcoma"
                      and complete the registration together.
                    """
                  }
                ]
              }
            ]
          },
          "stableIds": ["SELF_CURRENT_AGE", "SELF_COUNTRY", "SELF_STATE", "SELF_PROVINCE"],
          "precondition": """
            user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
            && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].isAnswered()
            && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].isAnswered()
            && (
              !user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasAnyOption("US", "CA")
              || (
                user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("US")
                && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_STATE"].isAnswered()
              ) || (
                user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("CA")
                && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_PROVINCE"].isAnswered()
              )
            )
          """,
          "expression": """
            ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("US")
              && (
                ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_STATE"].answers.hasOption("AL")
                  && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() < 19
                ) || (
                  !user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_STATE"].answers.hasOption("AL")
                  && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() < 18
                )
              )
            ) || (
              user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("CA")
              && (
                ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_PROVINCE"].answers.hasAnyOption("BC", "NB", "NL", "NT", "NS", "NU", "YT")
                  && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() < 19
                ) || (
                  user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_PROVINCE"].answers.hasAnyOption("AB", "MB", "ON", "PE", "QC", "SK")
                  && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() < 18
                )
              )
            ) || (
              user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("PR")
              && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() < 21
            ) || (
              user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasAnyOption("GU", "VI", "MP", "AS")
              && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() < 18
            )
          """
        },

        # complex validation for requiring child to self-consent
        {
          "messageTemplate": {
            "templateType": "HTML",
            "templateText": "$osteo_prequal_validation_child_self_consent",
            "variables": [
              {
                "name": "osteo_prequal_validation_child_self_consent",
                "translations": [
                  {
                    "language": "en",
                    "text": "In order to participate in the project, your child must consent and register on their own."
                  }
                ]
              }
            ]
          },
          "stableIds": ["CHILD_CURRENT_AGE", "CHILD_COUNTRY", "CHILD_STATE", "CHILD_PROVINCE"],
          "precondition": """
            user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
            && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].isAnswered()
            && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].isAnswered()
            && (
              !user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasAnyOption("US", "CA")
              || (
                user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("US")
                && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_STATE"].isAnswered()
              ) || (
                user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("CA")
                && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_PROVINCE"].isAnswered()
              )
            )
          """,
          "expression": """
            ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("US")
              && (
                ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_STATE"].answers.hasOption("AL")
                  && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() >= 19
                ) || (
                  !user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_STATE"].answers.hasOption("AL")
                  && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() >= 18
                )
              )
            ) || (
              user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("CA")
              && (
                ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_PROVINCE"].answers.hasAnyOption("BC", "NB", "NL", "NT", "NS", "NU", "YT")
                  && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() >= 19
                ) || (
                  user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_PROVINCE"].answers.hasAnyOption("AB", "MB", "ON", "PE", "QC", "SK")
                  && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() >= 18
                )
              )
            ) || (
              user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("PR")
              && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() >= 21
            ) || (
              user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasAnyOption("GU", "VI", "MP", "AS")
              && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() >= 18
            )
          """
        }
      ]
    },

    {
      "filepath": "self-consent.conf",
      "mappings": [
        {
          "type": "BLOOD",
          "stableId": "CONSENT_BLOOD"
        },
        {
          "type": "TISSUE",
          "stableId": "CONSENT_TISSUE"
        },
        {
          "type": "DATE_OF_BIRTH",
          "stableId": "CONSENT_DOB"
        }
      ],
      "validations": []
    },
    {
      "filepath": "parental-consent.conf",
      "mappings": [
        {
          "type": "BLOOD",
          "stableId": "PARENTAL_CONSENT_BLOOD"
        },
        {
          "type": "TISSUE",
          "stableId": "PARENTAL_CONSENT_TISSUE"
        },
        {
          "type": "DATE_OF_BIRTH",
          "stableId": "PARENTAL_CONSENT_CHILD_DOB"
        }
      ],
      "validations": []
    },
    {
      "filepath": "consent-assent.conf",
      "mappings": [
        {
          "type": "BLOOD",
          "stableId": "CONSENT_ASSENT_BLOOD"
        },
        {
          "type": "TISSUE",
          "stableId": "CONSENT_ASSENT_TISSUE"
        },
        {
          "type": "DATE_OF_BIRTH",
          "stableId": "CONSENT_ASSENT_CHILD_DOB"
        }
      ],
      "validations": []
    },
    {
      "filepath": "medical-release-self.conf",
      "mappings": [
        {
          "type": "MEDICAL_RELEASE",
          "stableId": null
        }
      ],
      "validations": []
    },
    {
      "filepath": "medical-release-minor.conf",
      "mappings": [
        {
          "type": "MEDICAL_RELEASE",
          "stableId": null
        }
      ],
      "validations": []
    },
    {
      "filepath": "about-you.conf",
      "mappings": [
        {
          "type": "DATE_OF_DIAGNOSIS",
          "stableId": "DIAGNOSIS_DATE"
        }
      ],
      "validations": []
    },
    {
      "filepath": "about-child.conf",
      "mappings": [
        {
          "type": "DATE_OF_DIAGNOSIS",
          "stableId": "CHILD_DIAGNOSIS_DATE"
        }
      ],
      "validations": []
    },
    {
      "filepath": "loved-one.conf",
      "mappings": [],
      "validations": []
    },
    {
      "filepath": "child-contact.conf",
      "mappings": [],
      "validations": []
    }
  ],

  "activityTimestamp": null,

  "activityStatusIcons": [
    {
      "filepath": "icons/created.svg",
      "statusType": "CREATED"
    },
    {
      "filepath": "icons/in_progress.svg",
      "statusType": "IN_PROGRESS"
    },
    {
      "filepath": "icons/complete.svg",
      "statusType": "COMPLETE"
    }
  ],

  "pdfs": [
    {
      "name": "osproject-consent",
      "filename": "osproject-consent",
      "displayName": "Osteo consent pdf",
      "mapping": {
        "type": "CONSENT"
      },
      "versions": [
        {
          "tag": "v1",
          "start": null,
          "end": null,
          "sources": [
            {
              "type": "ACTIVITY",
              "activityCode": "CONSENT",
              "versionTag": "v1"
            }
          ],
          "files": [
            {
              "filepath": "pdfs/consent.pdf",
              "type": "CUSTOM",
              "substitutions": [
                {
                  "type": "BOOLEAN",
                  "field": "blood_draw_yes",
                  "activityCode": "CONSENT",
                  "questionStableId": "CONSENT_BLOOD",
                  "checkIfFalse": false
                },
                {
                  "type": "BOOLEAN",
                  "field": "blood_draw_no",
                  "activityCode": "CONSENT",
                  "questionStableId": "CONSENT_BLOOD",
                  "checkIfFalse": true
                },
                {
                  "type": "BOOLEAN",
                  "field": "tissue_sample_yes",
                  "activityCode": "CONSENT",
                  "questionStableId": "CONSENT_TISSUE",
                  "checkIfFalse": false
                },
                {
                  "type": "BOOLEAN",
                  "field": "tissue_sample_no",
                  "activityCode": "CONSENT",
                  "questionStableId": "CONSENT_TISSUE",
                  "checkIfFalse": true
                },
                {
                  "type": "TEXT",
                  "field": "signature",
                  "activityCode": "CONSENT",
                  "questionStableId": "CONSENT_SIGNATURE"
                },
                {
                  "type": "DATE",
                  "field": "date_of_birth",
                  "activityCode": "CONSENT",
                  "questionStableId": "CONSENT_DOB"
                },
                {
                  "type": "ACTIVITY_DATE",
                  "field": "date",
                  "activityCode": "CONSENT"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "osproject-consent-parental",
      "filename": "osproject-consent-parental",
      "displayName": "Osteo parental consent pdf",
      "versions": [
        {
          "tag": "v1",
          "start": null,
          "end": null,
          "sources": [
            {
              "type": "ACTIVITY",
              "activityCode": "PARENTAL_CONSENT",
              "versionTag": "v1"
            }
          ],
          "files": [
            {
              "filepath": "pdfs/consent_parental.pdf",
              "type": "CUSTOM",
              "substitutions": [
                {
                  "type": "BOOLEAN",
                  "field": "blood_draw_yes",
                  "activityCode": "PARENTAL_CONSENT",
                  "questionStableId": "PARENTAL_CONSENT_BLOOD",
                  "checkIfFalse": false
                },
                {
                  "type": "BOOLEAN",
                  "field": "blood_draw_no",
                  "activityCode": "PARENTAL_CONSENT",
                  "questionStableId": "PARENTAL_CONSENT_BLOOD",
                  "checkIfFalse": true
                },
                {
                  "type": "BOOLEAN",
                  "field": "tissue_sample_yes",
                  "activityCode": "PARENTAL_CONSENT",
                  "questionStableId": "PARENTAL_CONSENT_TISSUE",
                  "checkIfFalse": false
                },
                {
                  "type": "BOOLEAN",
                  "field": "tissue_sample_no",
                  "activityCode": "PARENTAL_CONSENT",
                  "questionStableId": "PARENTAL_CONSENT_TISSUE",
                  "checkIfFalse": true
                },
                {
                  "type": "TEXT",
                  "field": "child_first_name",
                  "activityCode": "PARENTAL_CONSENT",
                  "questionStableId": "PARENTAL_CONSENT_CHILD_FIRSTNAME"
                },
                {
                  "type": "TEXT",
                  "field": "child_last_name",
                  "activityCode": "PARENTAL_CONSENT",
                  "questionStableId": "PARENTAL_CONSENT_CHILD_LASTNAME"
                },
                {
                  "type": "DATE",
                  "field": "child_date_of_birth",
                  "activityCode": "PARENTAL_CONSENT",
                  "questionStableId": "PARENTAL_CONSENT_CHILD_DOB"
                },
                {
                  "type": "TEXT",
                  "field": "signature",
                  "activityCode": "PARENTAL_CONSENT",
                  "questionStableId": "PARENTAL_CONSENT_SIGNATURE"
                },
                {
                  "type": "PICKLIST",
                  "field": "relationship",
                  "activityCode": "PARENTAL_CONSENT",
                  "questionStableId": "PARENTAL_CONSENT_RELATIONSHIP"
                },
                {
                  "type": "TEXT",
                  "field": "parental_first_name",
                  "activityCode": "PARENTAL_CONSENT",
                  "questionStableId": "PARENTAL_CONSENT_FIRSTNAME"
                },
                {
                  "type": "TEXT",
                  "field": "parental_last_name",
                  "activityCode": "PARENTAL_CONSENT",
                  "questionStableId": "PARENTAL_CONSENT_LASTNAME"
                },
                {
                  "type": "ACTIVITY_DATE",
                  "field": "date",
                  "activityCode": "PARENTAL_CONSENT"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "osproject-consent-assent",
      "filename": "osproject-consent-assent",
      "displayName": "Osteo parental consent & assent pdf",
      "versions": [
        {
          "tag": "v1",
          "start": null,
          "end": null,
          "sources": [
            {
              "type": "ACTIVITY",
              "activityCode": "CONSENT_ASSENT",
              "versionTag": "v1"
            }
          ],
          "files": [
            {
              "filepath": "pdfs/consent_assent.pdf",
              "type": "CUSTOM",
              "substitutions": [
                {
                  "type": "BOOLEAN",
                  "field": "blood_draw_yes",
                  "activityCode": "CONSENT_ASSENT",
                  "questionStableId": "CONSENT_ASSENT_BLOOD",
                  "checkIfFalse": false
                },
                {
                  "type": "BOOLEAN",
                  "field": "blood_draw_no",
                  "activityCode": "CONSENT_ASSENT",
                  "questionStableId": "CONSENT_ASSENT_BLOOD",
                  "checkIfFalse": true
                },
                {
                  "type": "BOOLEAN",
                  "field": "tissue_sample_yes",
                  "activityCode": "CONSENT_ASSENT",
                  "questionStableId": "CONSENT_ASSENT_TISSUE",
                  "checkIfFalse": false
                },
                {
                  "type": "BOOLEAN",
                  "field": "tissue_sample_no",
                  "activityCode": "CONSENT_ASSENT",
                  "questionStableId": "CONSENT_ASSENT_TISSUE",
                  "checkIfFalse": true
                },
                {
                  "type": "TEXT",
                  "field": "child_first_name",
                  "activityCode": "CONSENT_ASSENT",
                  "questionStableId": "CONSENT_ASSENT_CHILD_FIRSTNAME"
                },
                {
                  "type": "TEXT",
                  "field": "child_last_name",
                  "activityCode": "CONSENT_ASSENT",
                  "questionStableId": "CONSENT_ASSENT_CHILD_LASTNAME"
                },
                {
                  "type": "DATE",
                  "field": "child_date_of_birth",
                  "activityCode": "CONSENT_ASSENT",
                  "questionStableId": "CONSENT_ASSENT_CHILD_DOB"
                },
                {
                  "type": "TEXT",
                  "field": "relationship",
                  "activityCode": "CONSENT_ASSENT",
                  "questionStableId": "CONSENT_ASSENT_RELATIONSHIP"
                },
                {
                  "type": "TEXT",
                  "field": "parental_first_name",
                  "activityCode": "CONSENT_ASSENT",
                  "questionStableId": "CONSENT_ASSENT_FIRSTNAME"
                },
                {
                  "type": "TEXT",
                  "field": "parental_last_name",
                  "activityCode": "CONSENT_ASSENT",
                  "questionStableId": "CONSENT_ASSENT_LASTNAME"
                },
                {
                  "type": "TEXT",
                  "field": "signature",
                  "activityCode": "CONSENT_ASSENT",
                  "questionStableId": "CONSENT_ASSENT_PARENT_SIGNATURE"
                },
                {
                  "type": "ACTIVITY_DATE",
                  "field": "date",
                  "activityCode": "CONSENT_ASSENT"
                },
                {
                  "type": "TEXT",
                  "field": "child_signature",
                  "activityCode": "CONSENT_ASSENT",
                  "questionStableId": "CONSENT_ASSENT_CHILD_SIGNATURE"
                },
                {
                  "type": "ACTIVITY_DATE",
                  "field": "assent_date",
                  "activityCode": "CONSENT_ASSENT"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "osproject-release",
      "filename": "osproject-release",
      "displayName": "Osteo release pdf",
      "mapping": {
        "type": "RELEASE"
      },
      "versions": [
        {
          "tag": "v1",
          "start": null,
          "end": null,
          "sources": [
            {
              "type": "PARTICIPANT"
            },
            {
              "type": "ACTIVITY",
              "activityCode": "RELEASE_SELF",
              "versionTag": "v1"
            },
            {
              "type": "ACTIVITY",
              "activityCode": "CONSENT",
              "versionTag": "v1"
            }
          ],
          "files": [
            {
              "filepath": "pdfs/release_contact.pdf",
              "type": "MAILING_ADDRESS",
              "fields": {
                "firstName": "first_name",
                "lastName": "last_name",
                "street": "street",
                "city": "city",
                "state": "state",
                "zip": "zip",
                "country": "country",
                "phone": "phone"
              }
            },
            {
              "filepath": "pdfs/release_physician.pdf",
              "type": "PHYSICIAN",
              "fields": {
                "name": "physician_name",
                "institution": "physician_institution",
                "city": "physician_city",
                "state": "physician_state"
              }
            },
            {
              "filepath": "pdfs/release_biopsy.pdf",
              "type": "INITIAL_BIOPSY",
              "fields": {
                "institution": "biopsy_institution",
                "city": "biopsy_city",
                "state": "biopsy_state"
              }
            },
            {
              "filepath": "pdfs/release_institution.pdf",
              "type": "INSTITUTION",
              "fields": {
                "institution": "institution_name",
                "city": "institution_city",
                "state": "institution_state"
              }
            },
            {
              "filepath": "pdfs/release_agreement.pdf",
              "type": "CUSTOM",
              "substitutions": [
                {
                  "type": "TEXT",
                  "field": "signature",
                  "activityCode": "CONSENT",
                  "questionStableId": "CONSENT_SIGNATURE"
                },
                {
                  "type": "DATE",
                  "field": "date_of_birth",
                  "activityCode": "CONSENT",
                  "questionStableId": "CONSENT_DOB"
                },
                {
                  "type": "ACTIVITY_DATE",
                  "field": "date",
                  "activityCode": "RELEASE_SELF"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "osproject-release-parental",
      "filename": "osproject-release-parental",
      "displayName": "Osteo parental release pdf",
      "versions": [
        {
          "tag": "v1",
          "start": null,
          "end": null,
          "sources": [
            {
              "type": "PARTICIPANT"
            },
            {
              "type": "ACTIVITY",
              "activityCode": "RELEASE_MINOR",
              "versionTag": "v1"
            },
            {
              "type": "ACTIVITY",
              "activityCode": "PARENTAL_CONSENT",
              "versionTag": "v1"
            }
          ],
          "files": [
            {
              "filepath": "pdfs/release_parental_contact.pdf",
              "type": "MAILING_ADDRESS",
              "fields": {
                "proxyFirstName": "proxy_first_name",
                "proxyLastName": "proxy_last_name",
                "street": "street",
                "city": "city",
                "state": "state",
                "zip": "zip",
                "country": "country",
                "phone": "phone"
              }
            },
            {
              "filepath": "pdfs/release_parental_physician.pdf",
              "type": "PHYSICIAN",
              "fields": {
                "name": "physician_name",
                "institution": "physician_institution",
                "city": "physician_city",
                "state": "physician_state"
              }
            },
            {
              "filepath": "pdfs/release_parental_biopsy.pdf",
              "type": "INITIAL_BIOPSY",
              "fields": {
                "institution": "biopsy_institution",
                "city": "biopsy_city",
                "state": "biopsy_state"
              }
            },
            {
              "filepath": "pdfs/release_parental_institution.pdf",
              "type": "INSTITUTION",
              "fields": {
                "institution": "institution_name",
                "city": "institution_city",
                "state": "institution_state"
              }
            },
            {
              "filepath": "pdfs/release_parental_agreement.pdf",
              "type": "CUSTOM",
              "substitutions": [
                {
                  "type": "TEXT",
                  "field": "signature",
                  "activityCode": "PARENTAL_CONSENT",
                  "questionStableId": "PARENTAL_CONSENT_SIGNATURE"
                },
                {
                  "type": "ACTIVITY_DATE",
                  "field": "date",
                  "activityCode": "RELEASE_MINOR"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "osproject-release-consent-assent",
      "filename": "osproject-release-consent-assent",
      "displayName": "Osteo parental consent-assent release pdf",
      "versions": [
        {
          "tag": "v1",
          "start": null,
          "end": null,
          "sources": [
            {
              "type": "PARTICIPANT"
            },
            {
              "type": "ACTIVITY",
              "activityCode": "RELEASE_MINOR",
              "versionTag": "v1"
            },
            {
              "type": "ACTIVITY",
              "activityCode": "CONSENT_ASSENT",
              "versionTag": "v1"
            }
          ],
          "files": [
            {
              "filepath": "pdfs/release_parental_contact.pdf",
              "type": "MAILING_ADDRESS",
              "fields": {
                "proxyFirstName": "proxy_first_name",
                "proxyLastName": "proxy_last_name",
                "street": "street",
                "city": "city",
                "state": "state",
                "zip": "zip",
                "country": "country",
                "phone": "phone"
              }
            },
            {
              "filepath": "pdfs/release_parental_physician.pdf",
              "type": "PHYSICIAN",
              "fields": {
                "name": "physician_name",
                "institution": "physician_institution",
                "city": "physician_city",
                "state": "physician_state"
              }
            },
            {
              "filepath": "pdfs/release_parental_biopsy.pdf",
              "type": "INITIAL_BIOPSY",
              "fields": {
                "institution": "biopsy_institution",
                "city": "biopsy_city",
                "state": "biopsy_state"
              }
            },
            {
              "filepath": "pdfs/release_parental_institution.pdf",
              "type": "INSTITUTION",
              "fields": {
                "institution": "institution_name",
                "city": "institution_city",
                "state": "institution_state"
              }
            },
            {
              "filepath": "pdfs/release_parental_agreement.pdf",
              "type": "CUSTOM",
              "substitutions": [
                {
                  "type": "TEXT",
                  "field": "signature",
                  "activityCode": "CONSENT_ASSENT",
                  "questionStableId": "CONSENT_ASSENT_PARENT_SIGNATURE"
                },
                {
                  "type": "ACTIVITY_DATE",
                  "field": "date",
                  "activityCode": "RELEASE_MINOR"
                }
              ]
            }
          ]
        }
      ]
    }
  ],

  "workflowTransitions": [
    # main study workflow
    {
      "from": {
        "type": "START"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "PREQUAL",
          "expression": "true"
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY"
        "activityCode": "PREQUAL",
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "CONSENT",
          "expression": """user.studies["CMI-OSTEO"].forms["CONSENT"].hasInstance()"""
        },
        {
          "type": "ACTIVITY",
          "activityCode": "PARENTAL_CONSENT",
          "expression": """user.studies["CMI-OSTEO"].forms["PARENTAL_CONSENT"].hasInstance()"""
        },
        {
          "type": "ACTIVITY",
          "activityCode": "CONSENT_ASSENT",
          "expression": """user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].hasInstance()"""
        },
        {
          "type": "ACTIVITY",
          "activityCode": "LOVEDONE",
          "expression": """user.studies["CMI-OSTEO"].forms["LOVEDONE"].hasInstance()"""
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "CONSENT"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "RELEASE_SELF",
          "expression": """user.studies["CMI-OSTEO"].forms["RELEASE_SELF"].isStatus("CREATED", "IN_PROGRESS")"""
        },
        {
          "type": "ACTIVITY",
          "activityCode": "ABOUTYOU",
          "expression": """user.studies["CMI-OSTEO"].forms["ABOUTYOU"].isStatus("CREATED", "IN_PROGRESS")"""
        },
        {
          "type": "DASHBOARD",
          "expression": """user.studies["CMI-OSTEO"].forms["ABOUTYOU"].isStatus("COMPLETE")"""
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "PARENTAL_CONSENT"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "RELEASE_MINOR",
          "expression": """user.studies["CMI-OSTEO"].forms["RELEASE_MINOR"].isStatus("CREATED", "IN_PROGRESS")"""
        },
        {
          "type": "ACTIVITY",
          "activityCode": "ABOUTCHILD",
          "expression": """user.studies["CMI-OSTEO"].forms["ABOUTCHILD"].isStatus("CREATED", "IN_PROGRESS")"""
        },
        {
          "type": "DASHBOARD",
          "expression": """user.studies["CMI-OSTEO"].forms["ABOUTCHILD"].isStatus("COMPLETE")"""
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "CONSENT_ASSENT"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "RELEASE_MINOR",
          "expression": """user.studies["CMI-OSTEO"].forms["RELEASE_MINOR"].isStatus("CREATED", "IN_PROGRESS")"""
        },
        {
          "type": "ACTIVITY",
          "activityCode": "ABOUTCHILD",
          "expression": """user.studies["CMI-OSTEO"].forms["ABOUTCHILD"].isStatus("CREATED", "IN_PROGRESS")"""
        },
        {
          "type": "DASHBOARD",
          "expression": """user.studies["CMI-OSTEO"].forms["ABOUTCHILD"].isStatus("COMPLETE")"""
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "RELEASE_SELF"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "ABOUTYOU",
          "expression": """user.studies["CMI-OSTEO"].forms["ABOUTYOU"].isStatus("CREATED", "IN_PROGRESS")"""
        },
        {
          "type": "DASHBOARD",
          "expression": """user.studies["CMI-OSTEO"].forms["ABOUTYOU"].isStatus("COMPLETE")"""
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "RELEASE_MINOR"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "ABOUTCHILD",
          "expression": """user.studies["CMI-OSTEO"].forms["ABOUTCHILD"].isStatus("CREATED", "IN_PROGRESS")"""
        },
        {
          "type": "DASHBOARD",
          "expression": """user.studies["CMI-OSTEO"].forms["ABOUTCHILD"].isStatus("COMPLETE")"""
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "ABOUTYOU"
      },
      "to": [
        {
          "type": "DASHBOARD",
          "expression": """user.studies["CMI-OSTEO"].forms["ABOUTYOU"].isStatus("COMPLETE")"""
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "ABOUTCHILD"
      },
      "to": [
        {
          "type": "DASHBOARD",
          "expression": """user.studies["CMI-OSTEO"].forms["ABOUTCHILD"].isStatus("COMPLETE")"""
        }
      ]
    },

    # loved-one workflow
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "LOVEDONE"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "LOVEDONE",
          "expression": """user.studies["CMI-OSTEO"].forms["LOVEDONE"].isStatus("CREATED", "IN_PROGRESS")"""
        },
        {
          "type": "THANK_YOU",
          "expression": """user.studies["CMI-OSTEO"].forms["LOVEDONE"].isStatus("COMPLETE")"""
        }
      ]
    },

    # child-activity workflow
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "CHILD_CONTACT"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "CHILD_CONTACT",
          "expression": """user.studies["CMI-OSTEO"].forms["CHILD_CONTACT"].isStatus("CREATED", "IN_PROGRESS")"""
        },
        {
          "type": "DONE",
          "expression": """user.studies["CMI-OSTEO"].forms["CHILD_CONTACT"].isStatus("COMPLETE")"""
        }
      ]
    },

    # return user workflow
    {
      "from": {
        "type": "RETURN_USER"
      },
      "to": [
        {
          # Proxy haven't provided child contact email, so show it.
          "type": "ACTIVITY",
          "activityCode": "CHILD_CONTACT",
          "expression": """user.studies["CMI-OSTEO"].forms["CHILD_CONTACT"].isStatus("CREATED", "IN_PROGRESS")"""
        },
        {
          # Proxy has provided child contact email but child has not registered yet, so bring proxy to dashboard instead of resuming flow.
          "type": "DASHBOARD",
          "expression": """
            user.studies["CMI-OSTEO"].forms["CHILD_CONTACT"].isStatus("COMPLETE")
            && !user.studies["CMI-OSTEO"].forms["CONSENT"].hasInstance()
          """
        },

        # Prefer resuming self-consent flow when logging back in.
        {
          "type": "ACTIVITY",
          "activityCode": "CONSENT",
          "expression": """user.studies["CMI-OSTEO"].forms["CONSENT"].isStatus("CREATED", "IN_PROGRESS")"""
        },
        {
          "type": "ACTIVITY",
          "activityCode": "RELEASE_SELF",
          "expression": """user.studies["CMI-OSTEO"].forms["RELEASE_SELF"].isStatus("CREATED", "IN_PROGRESS")"""
        },
        {
          "type": "ACTIVITY",
          "activityCode": "ABOUTYOU",
          "expression": """user.studies["CMI-OSTEO"].forms["ABOUTYOU"].isStatus("CREATED", "IN_PROGRESS")"""
        },

        # Resume parental/assent flow, but only if haven't aged-up.
        {
          "type": "ACTIVITY",
          "activityCode": "PARENTAL_CONSENT",
          "expression": """
            user.studies["CMI-OSTEO"].forms["PARENTAL_CONSENT"].isStatus("CREATED", "IN_PROGRESS")
            && !user.studies["CMI-OSTEO"].hasAgedUp()
          """
        },
        {
          "type": "ACTIVITY",
          "activityCode": "CONSENT_ASSENT",
          "expression": """
            user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].isStatus("CREATED", "IN_PROGRESS")
            && !user.studies["CMI-OSTEO"].hasAgedUp()
          """
        },
        {
          "type": "ACTIVITY",
          "activityCode": "RELEASE_MINOR",
          "expression": """
            user.studies["CMI-OSTEO"].forms["RELEASE_MINOR"].isStatus("CREATED", "IN_PROGRESS")
            && !user.studies["CMI-OSTEO"].hasAgedUp()
          """
        },
        {
          "type": "ACTIVITY",
          "activityCode": "ABOUTCHILD",
          "expression": """
            user.studies["CMI-OSTEO"].forms["ABOUTCHILD"].isStatus("CREATED", "IN_PROGRESS")
            && !user.studies["CMI-OSTEO"].hasAgedUp()
          """
        },

        # Resume loved-one flow if applicable.
        {
          "type": "ACTIVITY",
          "activityCode": "LOVEDONE",
          "expression": """user.studies["CMI-OSTEO"].forms["LOVEDONE"].isStatus("CREATED", "IN_PROGRESS")"""
        },

        # Otherwise, fallback to dashboard.
        {
          "type": "DASHBOARD",
          "expression": "true"
        }
      ]
    }
  ],

  "events": [
    # populate profile events
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "COPY_ANSWER",
        "copyConfigPairs": [
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CONSENT_FIRSTNAME"
            },
            "target": {
              "type": "PARTICIPANT_PROFILE_FIRST_NAME"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CONSENT_LASTNAME"
            },
            "target": {
              "type": "PARTICIPANT_PROFILE_LAST_NAME"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CONSENT_DOB"
            },
            "target": {
              "type": "PARTICIPANT_PROFILE_BIRTH_DATE"
            }
          }
        ]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PARENTAL_CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "COPY_ANSWER",
        "copyConfigPairs": [
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "PARENTAL_CONSENT_CHILD_FIRSTNAME"
            },
            "target": {
              "type": "PARTICIPANT_PROFILE_FIRST_NAME"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "PARENTAL_CONSENT_CHILD_LASTNAME"
            },
            "target": {
              "type": "PARTICIPANT_PROFILE_LAST_NAME"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "PARENTAL_CONSENT_CHILD_DOB"
            },
            "target": {
              "type": "PARTICIPANT_PROFILE_BIRTH_DATE"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "PARENTAL_CONSENT_FIRSTNAME"
            },
            "target": {
              "type": "OPERATOR_PROFILE_FIRST_NAME"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "PARENTAL_CONSENT_LASTNAME"
            },
            "target": {
              "type": "OPERATOR_PROFILE_LAST_NAME"
            }
          }
        ]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ASSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "COPY_ANSWER",
        "copyConfigPairs": [
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CONSENT_ASSENT_CHILD_FIRSTNAME"
            },
            "target": {
              "type": "PARTICIPANT_PROFILE_FIRST_NAME"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CONSENT_ASSENT_CHILD_LASTNAME"
            },
            "target": {
              "type": "PARTICIPANT_PROFILE_LAST_NAME"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CONSENT_ASSENT_CHILD_DOB"
            },
            "target": {
              "type": "PARTICIPANT_PROFILE_BIRTH_DATE"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CONSENT_ASSENT_FIRSTNAME"
            },
            "target": {
              "type": "OPERATOR_PROFILE_FIRST_NAME"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CONSENT_ASSENT_LASTNAME"
            },
            "target": {
              "type": "OPERATOR_PROFILE_LAST_NAME"
            }
          }
        ]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },

    # activity instance creation events

    ## PREQUAL TO CONSENT
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PREQUAL",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "LOVEDONE"
      },
      "preconditionExpr": """user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DECEASED")""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PREQUAL",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "CONSENT"
      },
      "preconditionExpr": """user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
        && (
          ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("US")
            && (
              ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_STATE"].answers.hasOption("AL")
                && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() >= 19
              ) || (
                !user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_STATE"].answers.hasOption("AL")
                && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() >= 18
              )
            )
          ) || (
            user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("CA")
            && (
              ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_PROVINCE"].answers.hasAnyOption("BC", "NB", "NL", "NT", "NS", "NU", "YT")
                && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() >= 19
              ) || (
                user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_PROVINCE"].answers.hasAnyOption("AB", "MB", "ON", "PE", "QC", "SK")
                && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() >= 18
              )
            )
          ) || (
            user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasOption("PR")
            && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() >= 21
          ) || (
            user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_COUNTRY"].answers.hasAnyOption("GU", "VI", "MP", "AS")
            && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["SELF_CURRENT_AGE"].answers.value() >= 18
          )
        )
      """,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PREQUAL",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "PARENTAL_CONSENT"
      },
      "preconditionExpr": """user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
        && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() < 7)""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PREQUAL",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "CONSENT_ASSENT"
      },
      "preconditionExpr": """user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
        && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() >= 7
        && (
          ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("US")
            && (
              ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_STATE"].answers.hasOption("AL")
                && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() < 19
              ) || (
                !user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_STATE"].answers.hasOption("AL")
                && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() < 18
              )
            )
          ) || (
            user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("CA")
            && (
              ( user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_PROVINCE"].answers.hasAnyOption("BC", "NB", "NL", "NT", "NS", "NU", "YT")
                && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() < 19
              ) || (
                user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_PROVINCE"].answers.hasAnyOption("AB", "MB", "ON", "PE", "QC", "SK")
                && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() < 18
              )
            )
          ) || (
            user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasOption("PR")
            && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() < 21
          ) || (
            user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_COUNTRY"].answers.hasAnyOption("GU", "VI", "MP", "AS")
            && user.studies["CMI-OSTEO"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() < 18
          )
        )
        """,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 3
    },

    ## CONSENT TO RELEASE
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "RELEASE_SELF"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PARENTAL_CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "RELEASE_MINOR"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ASSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "RELEASE_MINOR"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },

    ## RELEASE TO ABOUT YOU
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE_SELF",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "ABOUTYOU"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE_MINOR",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "ABOUTCHILD"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },

    # email events

    ## join mailing list email
    {
      "trigger": {
        "type": "JOIN_MAILING_LIST"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.joinMailingList},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ## welcome email
    {
      "trigger": {
        "type": "USER_REGISTERED",
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.selfWelcome},
        "linkedActivityCode": "CONSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """!user.studies["CMI-OSTEO"].forms["CONSENT"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "USER_REGISTERED",
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalWelcome},
        "linkedActivityCode": "PARENTAL_CONSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """!user.studies["CMI-OSTEO"].forms["PARENTAL_CONSENT"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "USER_REGISTERED",
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalWelcome},
        "linkedActivityCode": "CONSENT_ASSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """!user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ## consent email
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.selfConsentCompleted},
        "linkedActivityCode": "RELEASE_SELF",
        "language": "en",
        "pdfAttachments": [
          { "pdfName": "osproject-consent", "generateIfMissing": true }
        ]
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].hasAgedUp()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PARENTAL_CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalConsentCompleted},
        "linkedActivityCode": "RELEASE_MINOR",
        "language": "en",
        "pdfAttachments": [
          { "pdfName": "osproject-consent-parental", "generateIfMissing": true }
        ]
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ASSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalConsentCompleted},
        "linkedActivityCode": "RELEASE_MINOR",
        "language": "en",
        "pdfAttachments": [
          { "pdfName": "osproject-consent-assent", "generateIfMissing": true }
        ]
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ## medical release email
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE_SELF",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.selfReleaseCompleted},
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].hasAgedUp()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE_MINOR",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalReleaseCompleted},
        "language": "en",
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ## consent reminder email
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.selfConsent1wkReminder},
        "linkedActivityCode": "CONSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["CONSENT"].isStatus("COMPLETE")
        || user.studies["CMI-OSTEO"].hasAgedUp()""",
      "delaySeconds": 604800, # one week in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PARENTAL_CONSENT",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalConsent1wkReminder},
        "linkedActivityCode": "PARENTAL_CONSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["PARENTAL_CONSENT"].isStatus("COMPLETE")""",
      "delaySeconds": 604800, # one week in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ASSENT",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalConsent1wkReminder},
        "linkedActivityCode": "CONSENT_ASSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].isStatus("COMPLETE")""",
      "delaySeconds": 604800, # one week in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.selfConsent2wkReminder},
        "linkedActivityCode": "CONSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["CONSENT"].isStatus("COMPLETE")
        || user.studies["CMI-OSTEO"].hasAgedUp()""",
      "delaySeconds": 1209600, # two weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PARENTAL_CONSENT",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalConsent2wkReminder},
        "linkedActivityCode": "PARENTAL_CONSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["PARENTAL_CONSENT"].isStatus("COMPLETE")""",
      "delaySeconds": 1209600, # two weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ASSENT",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalConsent2wkReminder},
        "linkedActivityCode": "CONSENT_ASSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].isStatus("COMPLETE")""",
      "delaySeconds": 1209600, # two weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.selfConsent3wkReminder},
        "linkedActivityCode": "CONSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["CONSENT"].isStatus("COMPLETE")
        || user.studies["CMI-OSTEO"].hasAgedUp()""",
      "delaySeconds": 1814400, # three weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PARENTAL_CONSENT",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalConsent3wkReminder},
        "linkedActivityCode": "PARENTAL_CONSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["PARENTAL_CONSENT"].isStatus("COMPLETE")""",
      "delaySeconds": 1814400, # three weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT_ASSENT",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalConsent3wkReminder},
        "linkedActivityCode": "CONSENT_ASSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].isStatus("COMPLETE")""",
      "delaySeconds": 1814400, # three weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ## release reminder email
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE_SELF",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.selfReleaseReminder},
        "linkedActivityCode": "RELEASE_SELF",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["RELEASE_SELF"].isStatus("COMPLETE")
        || user.studies["CMI-OSTEO"].hasAgedUp()""",
      "delaySeconds": 604800, # one week in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE_MINOR",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalReleaseReminder},
        "linkedActivityCode": "RELEASE_MINOR",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["RELEASE_MINOR"].isStatus("COMPLETE")""",
      "delaySeconds": 604800, # one week in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE_SELF",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.selfReleaseReminder},
        "linkedActivityCode": "RELEASE_SELF",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["RELEASE_SELF"].isStatus("COMPLETE")
        || user.studies["CMI-OSTEO"].hasAgedUp()""",
      "delaySeconds": 1209600, # two weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE_MINOR",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalReleaseReminder},
        "linkedActivityCode": "RELEASE_MINOR",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["RELEASE_MINOR"].isStatus("COMPLETE")""",
      "delaySeconds": 1209600, # two weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE_SELF",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.selfReleaseReminder},
        "linkedActivityCode": "RELEASE_SELF",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["RELEASE_SELF"].isStatus("COMPLETE")
        || user.studies["CMI-OSTEO"].hasAgedUp()""",
      "delaySeconds": 1814400, # three weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE_MINOR",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalReleaseReminder},
        "linkedActivityCode": "RELEASE_MINOR",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["RELEASE_MINOR"].isStatus("COMPLETE")""",
      "delaySeconds": 1814400, # three weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ## about-you reminder email
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "ABOUTYOU",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.aboutYouReminder},
        "linkedActivityCode": "ABOUTYOU",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["ABOUTYOU"].isStatus("COMPLETE")""",
      "delaySeconds": 604800, # one week in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "ABOUTCHILD",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.aboutChildReminder},
        "linkedActivityCode": "ABOUTCHILD",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["ABOUTCHILD"].isStatus("COMPLETE")""",
      "delaySeconds": 604800, # one week in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ## dsm notification emails
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "SALIVA_RECEIVED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.selfSalivaReceived},
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """!user.studies["CMI-OSTEO"].forms["CONSENT"].hasInstance()""",
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "SALIVA_RECEIVED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalSalivaReceived},
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["CONSENT"].hasInstance()""",
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "BLOOD_RECEIVED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.selfBloodReceived},
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """!user.studies["CMI-OSTEO"].forms["CONSENT"].hasInstance()""",
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "BLOOD_RECEIVED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalBloodReceived},
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["CONSENT"].hasInstance()""",
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "BLOOD_SENT"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.selfBloodSent},
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """!user.studies["CMI-OSTEO"].forms["CONSENT"].hasInstance()""",
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "BLOOD_SENT"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalBloodSent},
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["CONSENT"].hasInstance()""",
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "BLOOD_SENT_4WK"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.selfBloodSentReminder},
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """!user.studies["CMI-OSTEO"].forms["CONSENT"].hasInstance()""",
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "BLOOD_SENT_4WK"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalBloodSentReminder},
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["CONSENT"].hasInstance()""",
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # enrollment events
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE_SELF",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "USER_ENROLLED"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE_MINOR",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "USER_ENROLLED"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },

    # announcement events
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE_SELF",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ANNOUNCEMENT",
        "msgTemplate": { include required("snippets/thank-you-announcement-msg.conf") }
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE_MINOR",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ANNOUNCEMENT",
        "msgTemplate": { include required("snippets/thank-you-announcement-msg.conf") }
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },

    # medical update events for release pdfs
    {
      "trigger": {
        "type": "MEDICAL_UPDATE"
      },
      "action": {
        "type": "PDF_GENERATION",
        "pdfName": "osproject-release"
      },
      "cancelExpr": """
        ! (user.studies["CMI-OSTEO"].forms["CONSENT"].hasInstance()
        && user.studies["CMI-OSTEO"].forms["RELEASE_SELF"].hasInstance()
        && user.studies["CMI-OSTEO"].forms["CONSENT"].isStatus("COMPLETE")
        && user.studies["CMI-OSTEO"].forms["RELEASE_SELF"].isStatus("COMPLETE"))
      """,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "MEDICAL_UPDATE"
      },
      "action": {
        "type": "PDF_GENERATION",
        "pdfName": "osproject-release-parental"
      },
      "cancelExpr": """
        ! (user.studies["CMI-OSTEO"].forms["PARENTAL_CONSENT"].hasInstance()
        && user.studies["CMI-OSTEO"].forms["RELEASE_MINOR"].hasInstance()
        && user.studies["CMI-OSTEO"].forms["PARENTAL_CONSENT"].isStatus("COMPLETE")
        && user.studies["CMI-OSTEO"].forms["RELEASE_MINOR"].isStatus("COMPLETE"))
        || user.studies["CMI-OSTEO"].forms["RELEASE_SELF"].hasInstance()
      """,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "MEDICAL_UPDATE"
      },
      "action": {
        "type": "PDF_GENERATION",
        "pdfName": "osproject-release-consent-assent"
      },
      "cancelExpr": """
        ! (user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].hasInstance()
        && user.studies["CMI-OSTEO"].forms["RELEASE_MINOR"].hasInstance()
        && user.studies["CMI-OSTEO"].forms["CONSENT_ASSENT"].isStatus("COMPLETE")
        && user.studies["CMI-OSTEO"].forms["RELEASE_MINOR"].isStatus("COMPLETE"))
        || user.studies["CMI-OSTEO"].forms["RELEASE_SELF"].hasInstance()
      """,
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # reconsent events

    ## collecting child's contact email
    {
      "trigger": {
        "type": "REACHED_AOM_PREP",
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "CHILD_CONTACT"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CHILD_CONTACT",
        "statusType": "CREATED"
      }
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.reconsentChildContact},
        "linkedActivityCode": "CHILD_CONTACT",
        "language": "en",
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ## child-contact reminder emails
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CHILD_CONTACT",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.reconsentChildContact1wkReminder},
        "linkedActivityCode": "CHILD_CONTACT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["CHILD_CONTACT"].isStatus("COMPLETE")""",
      "delaySeconds": 604800, # one week in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CHILD_CONTACT",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.reconsentChildContact2wkReminder},
        "linkedActivityCode": "CHILD_CONTACT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["CHILD_CONTACT"].isStatus("COMPLETE")""",
      "delaySeconds": 1209600, # two weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CHILD_CONTACT",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.reconsentChildContact4wkReminder},
        "linkedActivityCode": "CHILD_CONTACT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["CMI-OSTEO"].forms["CHILD_CONTACT"].isStatus("COMPLETE")""",
      "delaySeconds": 2419200, # four weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ## verifying child's contact email
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CHILD_CONTACT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "CREATE_INVITATION",
        "markExistingAsVoided": true,
        "contactEmailQuestionStableId": "CHILD_CONTACT_EMAIL"
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "INVITATION_CREATED"
      },
      "action": {
        "type": "INVITATION_EMAIL",
        "emailTemplate": ${emails.reconsentEmailVerification},
        "language": "en",
        "pdfAttachments": []
      },
      # Invitation is created after participant reached age-of-majority,
      # so skip verify email since we'll send out the next-steps emails.
      "cancelExpr": """user.studies["CMI-OSTEO"].hasAgedUp()""",
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ## events at age-up
    {
      "trigger": {
        "type": "CONSENT_SUSPENDED"
      },
      "action": {
        "type": "MARK_ACTIVITIES_READ_ONLY",
        "activityCodes": ["PARENTAL_CONSENT", "CONSENT_ASSENT", "RELEASE_MINOR", "ABOUTCHILD"]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "REACHED_AOM"
      },
      "action": {
        "type": "INVITATION_EMAIL",
        "emailTemplate": ${emails.reconsentNextSteps},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ## reconsent/next steps reminder emails
    {
      "trigger": {
        "type": "REACHED_AOM"
      },
      "action": {
        "type": "INVITATION_EMAIL",
        "emailTemplate": ${emails.reconsentNextSteps1wkReminder},
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """(user.studies["CMI-OSTEO"].forms["CONSENT"].hasInstance()
        && user.studies["CMI-OSTEO"].forms["CONSENT"].isStatus("COMPLETE"))""",
      "delaySeconds": 604800, # one week in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "REACHED_AOM"
      },
      "action": {
        "type": "INVITATION_EMAIL",
        "emailTemplate": ${emails.reconsentNextSteps2wkReminder},
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """(user.studies["CMI-OSTEO"].forms["CONSENT"].hasInstance()
        && user.studies["CMI-OSTEO"].forms["CONSENT"].isStatus("COMPLETE"))""",
      "delaySeconds": 1209600, # two weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "REACHED_AOM"
      },
      "action": {
        "type": "INVITATION_EMAIL",
        "emailTemplate": ${emails.reconsentNextSteps4wkReminder},
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """(user.studies["CMI-OSTEO"].forms["CONSENT"].hasInstance()
        && user.studies["CMI-OSTEO"].forms["CONSENT"].isStatus("COMPLETE"))""",
      "delaySeconds": 2419200, # four weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ## after child registration
    {
      "trigger": {
        "type": "GOVERNED_USER_REGISTERED"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "CONSENT"
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "GOVERNED_USER_REGISTERED"
      },
      "action": {
        "type": "HIDE_ACTIVITIES",
        "activityCodes": ["CHILD_CONTACT"]
      },
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "GOVERNED_USER_REGISTERED",
      },
      "action": {
        "type": "ANNOUNCEMENT",
        "permanent": true,
        "createForProxies": true,
        "msgTemplate": { include required("snippets/former-proxy-announcement-msg.conf") }
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 3
    },
    {
      "trigger": {
        "type": "GOVERNED_USER_REGISTERED"
      },
      "action": {
        "type": "REVOKE_PROXIES"
      },
      "dispatchToHousekeeping": false,
      # Order here is important. Since announcement `createForProxies` only create for active proxies,
      # we should queue up announcement before inactivating proxy.
      "order": 4
    },

    ## after submitting new consent
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.reconsentThankYou},
        "language": "en",
        "pdfAttachments": [
          { "pdfName": "osproject-consent", "generateIfMissing": true }
        ]
      },
      "cancelExpr": """!user.studies["CMI-OSTEO"].hasAgedUp()""",
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "HIDE_ACTIVITIES",
        "activityCodes": ["RELEASE_MINOR"],
      },
      "cancelExpr": """!user.studies["CMI-OSTEO"].forms["RELEASE_MINOR"].hasInstance()""",
      "dispatchToHousekeeping": false,
      "order": 1
    },

    ## after submitting new release
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE_SELF",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.reconsentReleaseCompleted},
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """!user.studies["CMI-OSTEO"].hasAgedUp()""",
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE_SELF",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "HIDE_ACTIVITIES",
        "activityCodes": ["ABOUTCHILD"],
      },
      "cancelExpr": """!user.studies["CMI-OSTEO"].forms["ABOUTCHILD"].hasInstance()""",
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "ABOUTYOU",
        "statusType": "CREATED"
      },
      "action": {
        "type": "COPY_ANSWER",
        "copyConfigPairs": [
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CHILD_DIAGNOSIS_DATE"
            },
            "target": {
              "type": "ANSWER",
              "questionStableId": "DIAGNOSIS_DATE"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CHILD_SYMPTOMS_START_TIME"
            },
            "target": {
              "type": "ANSWER",
              "questionStableId": "SYMPTOMS_START_TIME"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CHILD_INITIAL_BODY_LOC"
            },
            "target": {
              "type": "ANSWER",
              "questionStableId": "INITIAL_BODY_LOC"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CHILD_CURRENT_BODY_LOC"
            },
            "target": {
              "type": "ANSWER",
              "questionStableId": "CURRENT_BODY_LOC"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CHILD_HAD_RADIATION"
            },
            "target": {
              "type": "ANSWER",
              "questionStableId": "HAD_RADIATION"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CHILD_THERAPIES_RECEIVED"
            },
            "target": {
              "type": "ANSWER",
              "questionStableId": "THERAPIES_RECEIVED"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CHILD_EVER_RELAPSED"
            },
            "target": {
              "type": "ANSWER",
              "questionStableId": "EVER_RELAPSED"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CHILD_CURRENTLY_TREATED"
            },
            "target": {
              "type": "ANSWER",
              "questionStableId": "CURRENTLY_TREATED"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CHILD_OTHER_CANCERS"
            },
            "target": {
              "type": "ANSWER",
              "questionStableId": "OTHER_CANCERS"
            }
          },
          {
            # composite parent: CHILD_OTHER_CANCERS_LIST -> OTHER_CANCERS_LIST
            "source": {
              "type": "ANSWER",
              "questionStableId": "CHILD_OTHER_CANCER_NAME"
            },
            "target": {
              "type": "ANSWER",
              "questionStableId": "OTHER_CANCER_NAME"
            }
          },
          {
            # composite parent: CHILD_OTHER_CANCERS_LIST -> OTHER_CANCERS_LIST
            "source": {
              "type": "ANSWER",
              "questionStableId": "CHILD_OTHER_CANCER_YEAR"
            },
            "target": {
              "type": "ANSWER",
              "questionStableId": "OTHER_CANCER_YEAR"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CHILD_EXPERIENCE"
            },
            "target": {
              "type": "ANSWER",
              "questionStableId": "EXPERIENCE"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CHILD_HISPANIC"
            },
            "target": {
              "type": "ANSWER",
              "questionStableId": "HISPANIC"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CHILD_RACE"
            },
            "target": {
              "type": "ANSWER",
              "questionStableId": "RACE"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CHILD_HOW_HEAR"
            },
            "target": {
              "type": "ANSWER",
              "questionStableId": "HOW_HEAR"
            }
          },
        ]
      },
      "cancelExpr": """!user.studies["CMI-OSTEO"].forms["ABOUTCHILD"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },

    # exit request event
    {
      "trigger": {
        "type": "EXIT_REQUEST"
      },
      "action": {
        "type": "STUDY_EMAIL",
        "emailTemplate": ${emails.exitRequest},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    }
  ]
}
