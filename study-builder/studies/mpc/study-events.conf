{
  "events": [
    # join mailing list event
    {
      "trigger": {
        "type": "JOIN_MAILING_LIST"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.joinMailingList},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # populate profile events
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PREQUAL",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "COPY_ANSWER",
        "copyConfigPairs": [
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "PREQUAL_FIRST_NAME"
            },
            "target": {
              "type": "PARTICIPANT_PROFILE_FIRST_NAME"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "PREQUAL_LAST_NAME"
            },
            "target": {
              "type": "PARTICIPANT_PROFILE_LAST_NAME"
            }
          }
        ]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },

    # activity instance creation events
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PREQUAL",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "ABOUTYOU"
      },
      "cancelExpr": """
        !user.studies["cmi-mpc"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
      """,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "ABOUTYOU",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "CONSENT"
      },
      "cancelExpr": """
        !user.studies["cmi-mpc"].forms["ABOUTYOU"].questions["COUNTRY"].answers.hasAnyOption("US", "CA", "PR", "GU", "VI", "MP", "AS")
      """,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "RELEASE"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },

    # registration event
    {
      "trigger": {
        "type": "USER_REGISTERED",
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.welcome},
        "linkedActivityCode": "ABOUTYOU",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """
        !user.studies["cmi-mpc"].forms["PREQUAL"].hasInstance()
        || !user.studies["cmi-mpc"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
      """,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # activity status email events
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.aboutyouCompleted},
        "linkedActivityCode": "CONSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.consentCompleted},
        "linkedActivityCode": "RELEASE",
        "language": "en",
        "pdfAttachments": [
          {"pdfName": "mpcproject-consent", "generateIfMissing": true}
        ]
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.releaseCompleted},
        "language": "en",
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # pdf generation event for release pdfs
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "PDF_GENERATION",
        "pdfName": "mpcproject-release"
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # medical update event for release pdfs
    {
      "trigger": {
        "type": "MEDICAL_UPDATE"
      },
      "action": {
        "type": "PDF_GENERATION",
        "pdfName": "mpcproject-release"
      },
      "cancelExpr": """!(user.studies["cmi-mpc"].forms["RELEASE"].hasInstance()
            && user.studies["cmi-mpc"].forms["RELEASE"].isStatus("COMPLETE"))"""
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # reminder email events
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.consentFirstReminder},
        "linkedActivityCode": "CONSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """
        user.studies["cmi-mpc"].forms["CONSENT"].isStatus("COMPLETE")
        || !user.studies["cmi-mpc"].forms["ABOUTYOU"].questions["COUNTRY"].answers.hasAnyOption("US", "CA", "PR", "GU", "VI", "MP", "AS")
      """,
      "delaySeconds": 604800, # one week in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.consentSecondReminder},
        "linkedActivityCode": "CONSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """
        user.studies["cmi-mpc"].forms["CONSENT"].isStatus("COMPLETE")
        || !user.studies["cmi-mpc"].forms["ABOUTYOU"].questions["COUNTRY"].answers.hasAnyOption("US", "CA", "PR", "GU", "VI", "MP", "AS")
      """,
      "delaySeconds": 1209600, # two weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.consentThirdReminder},
        "linkedActivityCode": "CONSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """
        user.studies["cmi-mpc"].forms["CONSENT"].isStatus("COMPLETE")
        || !user.studies["cmi-mpc"].forms["ABOUTYOU"].questions["COUNTRY"].answers.hasAnyOption("US", "CA", "PR", "GU", "VI", "MP", "AS")
      """,
      "delaySeconds": 1814400, # three weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.releaseReminder},
        "linkedActivityCode": "RELEASE",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-mpc"].forms["RELEASE"].isStatus("COMPLETE")""",
      "delaySeconds": 604800, # one week in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.releaseReminder},
        "linkedActivityCode": "RELEASE",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-mpc"].forms["RELEASE"].isStatus("COMPLETE")""",
      "delaySeconds": 1209600, # two weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE",
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.releaseReminder},
        "linkedActivityCode": "RELEASE",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-mpc"].forms["RELEASE"].isStatus("COMPLETE")""",
      "delaySeconds": 1814400, # three weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # enrollment event
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "USER_ENROLLED"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },

    # announcement event
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "RELEASE",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ANNOUNCEMENT",
        "msgTemplate": {include required("snippets/thank-you-announcement-msg.conf")}
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },

    # dsm notification email events
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "SALIVA_RECEIVED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.salivaReceived},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "BLOOD_RECEIVED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.bloodReceived},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "BLOOD_SENT"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.bloodSent},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "BLOOD_SENT_4WK"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.bloodSentReminder},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # exit request event
    {
      "trigger": {
        "type": "EXIT_REQUEST"
      },
      "action": {
        "type": "STUDY_EMAIL",
        "emailTemplate": ${emails.exitRequest},
        "language": "en",
        "pdfAttachments": []
      },
      "preconditionExpr": null,
      "cancelExpr": null,
      "maxOccurrencesPerUser": null,
      "delaySeconds": null,
      "dispatchToHousekeeping": true,
      "order": 1
    }
  ]
}
