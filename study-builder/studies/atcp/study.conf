{
  "tenant": {
    "domain": ${auth0.domain},
    "mgmtClientId": ${auth0.mgmtClientId},
    "mgmtSecret": ${auth0.mgmtSecret}
  },

  "umbrella": {
    "name": "CMI",
    "guid": "cmi"
  },

  "study": {
    "name": "atproject",
    "guid": "CMI-AT",
    "studyEmail": "info@osproject.org",
    "baseWebUrl": ${baseWebUrl},
    "irbPassword": ${irbPassword},
    "plusCodePrecision": "MEDIUM",
    "shareParticipantLocation": true
  },

  "client": {
    "name": "atcp-angular-client",
    "id": ${auth0.clientId},
    "secret": ${auth0.clientSecret},
    "passwordRedirectUrl": ${passwordRedirectUrl}
  },

  "adminUser": {
    "guid": "CMIPEPPERADMINUSER"
  },

  "studyDetails": [],

  "sendgrid": {
    "apiKey": ${sendgridApiKey},
    "fromName": ${sendgridFromName},
    "fromEmail": ${sendgridFromEmail},
    "defaultSalutation": ${sendgridDefaultSalutation}
  },

  "kits": [],

  "activities": [
    {
      "filepath": "prequal.conf",
      "mappings": [],
      "validations": []
    },

    {
      "filepath": "self-consent.conf",
      "mappings": [
        {
          "type": "BLOOD",
          "stableId": "CONSENT_BLOOD"
        },
        {
          "type": "TISSUE",
          "stableId": "CONSENT_TISSUE"
        },
        {
          "type": "DATE_OF_BIRTH",
          "stableId": "CONSENT_DOB"
        }
      ],
      "validations": []
    },
    {
      "filepath": "parental-consent.conf",
      "mappings": [
        {
          "type": "BLOOD",
          "stableId": "PARENTAL_CONSENT_BLOOD"
        },
        {
          "type": "TISSUE",
          "stableId": "PARENTAL_CONSENT_TISSUE"
        },
        {
          "type": "DATE_OF_BIRTH",
          "stableId": "PARENTAL_CONSENT_CHILD_DOB"
        }
      ],
      "validations": []
    },
    {
      "filepath": "stay-informed.conf",
      "mappings": [],
      "validations": []
    },
    {
      "filepath": "contacting-physician.conf",
      "mappings": [],
      "validations": []
    }
  ],

  "activityTimestamp": null,

  "activityStatusIcons": [
    {
      "filepath": "icons/created.svg",
      "statusType": "CREATED"
    },
    {
      "filepath": "icons/in_progress.svg",
      "statusType": "IN_PROGRESS"
    },
    {
      "filepath": "icons/complete.svg",
      "statusType": "COMPLETE"
    }
  ],

  "pdfs": [],

  "workflowTransitions": [
    # main study workflow
    {
      "from": {
        "type": "START"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "PREQUAL",
          "expression": "true"
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY"
        "activityCode": "PREQUAL",
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "CONSENT",
          "expression": """user.studies["CMI-AT"].forms["CONSENT"].hasInstance()"""
        },
        {
          "type": "ACTIVITY",
          "activityCode": "PARENTAL_CONSENT",
          "expression": """user.studies["CMI-AT"].forms["PARENTAL_CONSENT"].hasInstance()"""
        },
        {
          "type": "ACTIVITY",
          "activityCode": "STAY_INFORMED",
          "expression": """user.studies["CMI-AT"].forms["STAY_INFORMED"].hasInstance()"""
        }
      ]
    },
//    {
//      "from": {
//        "type": "ACTIVITY",
//        "activityCode": "CONSENT"
//      },
//      "to": [
//        {
//          "type": "DASHBOARD",
//          "expression": """user.studies["CMI-AT"].forms["CONSENT"].isStatus("COMPLETE")"""
//        }
//      ]
//    },
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "CONSENT"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "CONTACTING_PHYSICIAN",
          "expression": """user.studies["CMI-AT"].forms["CONSENT"].isStatus("COMPLETE")"""
        }
      ]
    },
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "CONTACTING_PHYSICIAN"
      },
      "to": [
        {
          "type": "DASHBOARD",
          "expression": """user.studies["CMI-AT"].forms["CONTACTING_PHYSICIAN"].isStatus("COMPLETE")"""
        }
      ]
    },

    # loved-one workflow
    {
      "from": {
        "type": "ACTIVITY",
        "activityCode": "STAY_INFORMED"
      },
      "to": [
        {
          "type": "ACTIVITY",
          "activityCode": "STAY_INFORMED",
          "expression": """user.studies["CMI-AT"].forms["STAY_INFORMED"].isStatus("CREATED", "IN_PROGRESS")"""
        },
        {
          "type": "THANK_YOU",
          "expression": """user.studies["CMI-AT"].forms["STAY_INFORMED"].isStatus("COMPLETE")"""
        }
      ]
    },

    # child-activity workflow

    # return user workflow
  ],

  "events": [
    # populate profile events
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "COPY_ANSWER",
        "copyConfigPairs": [
//          {
//            "source": {
//              "type": "ANSWER",
//              "questionStableId": "CONSENT_FIRSTNAME"
//            },
//            "target": {
//              "type": "PARTICIPANT_PROFILE_FIRST_NAME"
//            }
//          },
//          {
//            "source": {
//              "type": "ANSWER",
//              "questionStableId": "CONSENT_LASTNAME"
//            },
//            "target": {
//              "type": "PARTICIPANT_PROFILE_LAST_NAME"
//            }
//          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "CONSENT_DOB"
            },
            "target": {
              "type": "PARTICIPANT_PROFILE_BIRTH_DATE"
            }
          }
        ]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PARENTAL_CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "COPY_ANSWER",
        "copyConfigPairs": [
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "PARENTAL_CONSENT_CHILD_FIRSTNAME"
            },
            "target": {
              "type": "PARTICIPANT_PROFILE_FIRST_NAME"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "PARENTAL_CONSENT_CHILD_LASTNAME"
            },
            "target": {
              "type": "PARTICIPANT_PROFILE_LAST_NAME"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "PARENTAL_CONSENT_CHILD_DOB"
            },
            "target": {
              "type": "PARTICIPANT_PROFILE_BIRTH_DATE"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "PARENTAL_CONSENT_FIRSTNAME"
            },
            "target": {
              "type": "OPERATOR_PROFILE_FIRST_NAME"
            }
          },
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": "PARENTAL_CONSENT_LASTNAME"
            },
            "target": {
              "type": "OPERATOR_PROFILE_LAST_NAME"
            }
          }
        ]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },

    # activity instance creation events

    ## PREQUAL TO CONSENT
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PREQUAL",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "STAY_INFORMED"
      },
      "preconditionExpr": """user.studies["CMI-AT"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("INFORMED")""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PREQUAL",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "CONSENT"
      },
      "preconditionExpr": """user.studies["CMI-AT"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")"""
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "PREQUAL",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "PARENTAL_CONSENT"
      },
      "preconditionExpr": """user.studies["CMI-AT"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("CHILD_DIAGNOSED")
        && user.studies["CMI-AT"].forms["PREQUAL"].questions["CHILD_CURRENT_AGE"].answers.value() < 7)""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },

    ## CONSENT TO CONTACTING_PHYSICIAN
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": "CONTACTING_PHYSICIAN"
      },
      "preconditionExpr": null,
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },

    ## CONSENT TO CHILD_ASSENT

    ## CHILD_ASSENT TO PHYSICIAN_INFORMATION

    ## PHYSICIAN_INFORMATION TO MEDICAL_HISTORY

    ## MEDICAL_HISTORY TO GENOME_STUDY

    ## GENOME_STUDY TO REVIEW

    ## CONSENT TO RELEASE


    # email events

    ## join mailing list email
    {
      "trigger": {
        "type": "JOIN_MAILING_LIST"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.joinMailingList},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ## welcome email
    {
      "trigger": {
        "type": "USER_REGISTERED",
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.selfWelcome},
        "linkedActivityCode": "CONSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """!user.studies["CMI-AT"].forms["CONSENT"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "USER_REGISTERED",
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.parentalWelcome},
        "linkedActivityCode": "PARENTAL_CONSENT",
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """!user.studies["CMI-AT"].forms["PARENTAL_CONSENT"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },


    # enrollment events

    # announcement events

    # medical update events for release pdfs

    # reconsent events

    ## events at age-up
    {
      "trigger": {
        "type": "REACHED_AOM"
      },
      "action": {
        "type": "INVITATION_EMAIL",
        "emailTemplate": ${emails.reconsentNextSteps},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ## reconsent/next steps reminder emails
    {
      "trigger": {
        "type": "REACHED_AOM"
      },
      "action": {
        "type": "INVITATION_EMAIL",
        "emailTemplate": ${emails.reconsentNextSteps1wkReminder},
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """(user.studies["CMI-AT"].forms["CONSENT"].hasInstance()
        && user.studies["CMI-AT"].forms["CONSENT"].isStatus("COMPLETE"))""",
      "delaySeconds": 604800, # one week in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "REACHED_AOM"
      },
      "action": {
        "type": "INVITATION_EMAIL",
        "emailTemplate": ${emails.reconsentNextSteps2wkReminder},
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """(user.studies["CMI-AT"].forms["CONSENT"].hasInstance()
        && user.studies["CMI-AT"].forms["CONSENT"].isStatus("COMPLETE"))""",
      "delaySeconds": 1209600, # two weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "REACHED_AOM"
      },
      "action": {
        "type": "INVITATION_EMAIL",
        "emailTemplate": ${emails.reconsentNextSteps4wkReminder},
        "language": "en",
        "pdfAttachments": []
      },
      "cancelExpr": """(user.studies["CMI-AT"].forms["CONSENT"].hasInstance()
        && user.studies["CMI-AT"].forms["CONSENT"].isStatus("COMPLETE"))""",
      "delaySeconds": 2419200, # four weeks in seconds
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ## after child registration

    ## after submitting new consent
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.reconsentThankYou},
        "language": "en",
        "pdfAttachments": [
//          { "pdfName": "osproject-consent", "generateIfMissing": true }
        ]
      },
      "cancelExpr": "",
      "dispatchToHousekeeping": true,
      "order": 1
    },

    ## after submitting new release

    # exit request event
    {
      "trigger": {
        "type": "EXIT_REQUEST"
      },
      "action": {
        "type": "STUDY_EMAIL",
        "emailTemplate": ${emails.exitRequest},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    }
  ]
}
