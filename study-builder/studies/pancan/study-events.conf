{
  "events": [
    # When prequal submitted
    ## Create consent activities
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.prequal},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.consent}
      },
      "preconditionExpr": ${_pex.is_self}"&&"${_pex.is_age_of_majority},
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.prequal},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.parental}
      },
      # We want to make sure we did not redirect. Other consent cases check the country, which is a
      # good indicator of not-redirected. We do the same here for parental case.
      "preconditionExpr": ${_pex.is_child_only}"&&"${_pex.is_country_answered}"&&"${_pex.is_age_parental},
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.prequal},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.assent}
      },
      "preconditionExpr": ${_pex.is_child_only}"&&"${_pex.is_age_assent},
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 3
    },

    # When user registered
    ## Send welcome email
    {
      "trigger": {
        "type": "USER_REGISTERED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_welcome}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_welcome}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },
    ## Queue announcement message
    {
      "trigger": {
        "type": "USER_REGISTERED"
      },
      "action": {
        "type": "ANNOUNCEMENT",
        "msgTemplate": ${_includes.announcement_self},
      },
      "preconditionExpr": """user.studies["cmi-pancan"].forms["CONSENT"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "USER_REGISTERED"
      },
      "action": {
        "type": "ANNOUNCEMENT",
        "msgTemplate": ${_includes.announcement_child},
      },
      "preconditionExpr": """!user.studies["cmi-pancan"].forms["CONSENT"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },

    # When consent created
    ## Queue up 1 week reminders
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.consent},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT"].isStatus("COMPLETE")
        || user.studies["cmi-pancan"].hasAgedUp()""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.parental},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.parental},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT_PARENTAL"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.assent},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.assent},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT_ASSENT"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    ## Queue up 2 week reminders
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.consent},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT"].isStatus("COMPLETE")
        || user.studies["cmi-pancan"].hasAgedUp()""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.parental},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.parental},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT_PARENTAL"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.assent},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.assent},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT_ASSENT"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 2
    },
    ## Queue up 3 week reminders
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.consent},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT"].isStatus("COMPLETE")
        || user.studies["cmi-pancan"].hasAgedUp()""",
      "delaySeconds": ${timeout.secs_3_week},
      "dispatchToHousekeeping": true,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.parental},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.parental},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT_PARENTAL"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_3_week},
      "dispatchToHousekeeping": true,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.assent},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.assent},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["CONSENT_ASSENT"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_3_week},
      "dispatchToHousekeeping": true,
      "order": 3
    },

    # When consent submitted
    ## Copy answers to profile
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "COPY_ANSWER",
        "copyConfigPairs": [
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.consent_firstname} },
            "target": { "type": "PARTICIPANT_PROFILE_FIRST_NAME" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.consent_lastname} },
            "target": { "type": "PARTICIPANT_PROFILE_LAST_NAME" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.consent_dob} },
            "target": { "type": "PARTICIPANT_PROFILE_BIRTH_DATE" }
          }
        ]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.parental},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "COPY_ANSWER",
        "copyConfigPairs": [
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.parental_child_firstname} },
            "target": { "type": "PARTICIPANT_PROFILE_FIRST_NAME" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.parental_child_lastname} },
            "target": { "type": "PARTICIPANT_PROFILE_LAST_NAME" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.parental_child_dob} },
            "target": { "type": "PARTICIPANT_PROFILE_BIRTH_DATE" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.parental_firstname} },
            "target": { "type": "OPERATOR_PROFILE_FIRST_NAME" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.parental_lastname} },
            "target": { "type": "OPERATOR_PROFILE_LAST_NAME" }
          }
        ]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.assent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "COPY_ANSWER",
        "copyConfigPairs": [
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.assent_child_firstname} },
            "target": { "type": "PARTICIPANT_PROFILE_FIRST_NAME" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.assent_child_lastname} },
            "target": { "type": "PARTICIPANT_PROFILE_LAST_NAME" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.assent_child_dob} },
            "target": { "type": "PARTICIPANT_PROFILE_BIRTH_DATE" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.assent_firstname} },
            "target": { "type": "OPERATOR_PROFILE_FIRST_NAME" }
          },
          {
            "source": { "type": "ANSWER", "questionStableId": ${id.q.assent_lastname} },
            "target": { "type": "OPERATOR_PROFILE_LAST_NAME" }
          }
        ]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },
    ## Create release activity
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.release}
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    }
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.parental},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.release_minor}
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    }
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.assent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.release_minor}
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    ## Queue up completed email
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentCompleted}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentCompleted}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release},
        "pdfAttachments": [
          // { "pdfName": "countmein-consent" }
        ]
      },
      "cancelExpr": """user.studies["cmi-pancan"].hasAgedUp()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.parental},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentCompleted}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentCompleted}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release_minor},
        "pdfAttachments": [
          // { "pdfName": "countmein-consent-parental" }
        ]
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.assent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentCompleted}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consentCompleted}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release_minor},
        "pdfAttachments": [
          // { "pdfName": "countmein-consent-assent" }
        ]
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 3
    },
    ## Mark user status as enrolled
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "USER_ENROLLED"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 4
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.parental},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "USER_ENROLLED"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 4
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.assent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "USER_ENROLLED"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 4
    },

    # When release created
    ## Queue up 1 week reminders
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_releaseReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_releaseReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["RELEASE"].isStatus("COMPLETE")
        || user.studies["cmi-pancan"].hasAgedUp()""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_releaseReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_releaseReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release_minor},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["RELEASE_MINOR"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_1_week},
      "dispatchToHousekeeping": true,
      "order": 1
    },
    ## Queue up 2 week reminders
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_releaseReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_releaseReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["RELEASE"].isStatus("COMPLETE")
        || user.studies["cmi-pancan"].hasAgedUp()""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_releaseReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_releaseReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release_minor},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["RELEASE_MINOR"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_2_week},
      "dispatchToHousekeeping": true,
      "order": 2
    },
    ## Queue up 3 week reminders
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_releaseReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_releaseReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["RELEASE"].isStatus("COMPLETE")
        || user.studies["cmi-pancan"].hasAgedUp()""",
      "delaySeconds": ${timeout.secs_3_week},
      "dispatchToHousekeeping": true,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_releaseReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_releaseReminder}, "language": "es", "isDynamic": true },
        ],
        "linkedActivityCode": ${id.act.release_minor},
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].forms["RELEASE_MINOR"].isStatus("COMPLETE")""",
      "delaySeconds": ${timeout.secs_3_week},
      "dispatchToHousekeeping": true,
      "order": 3
    },

    # When release submitted
    ## Create about-cancer instances based on cancer selections from prequal
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.about_cancer},
        "createFromAnswer": true,
        "sourceQuestionStableId": ${id.q.primary_cancer_list_self},
        "targetQuestionStableId": ${id.q.diagnosis_type}
      },
      # If there's already about-cancer instances, then don't create any more.
      "preconditionExpr": """!user.studies["cmi-pancan"].forms["ABOUT_CANCER"].hasInstance()
      && (user.studies["cmi-pancan"].forms["PREQUAL"].questions["DESCRIBE"].answers.hasOption("DIAGNOSED"))""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.about_cancer},
        "createFromAnswer": true,
        "sourceQuestionStableId": ${id.q.primary_cancer_list_child},
        "targetQuestionStableId": ${id.q.diagnosis_type}
      },
      # If there's already about-cancer instances, then don't create any more.
      "preconditionExpr": """!user.studies["cmi-pancan"].forms["ABOUT_CANCER"].hasInstance()
      && """ ${_pex.is_child_only},
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.about_cancer},
        "createFromAnswer": true,
        "sourceQuestionStableId": ${id.q.primary_cancer_list_self},
        "targetQuestionStableId": ${id.q.diagnosis_type}
      },
      # If there's already about-cancer instances, then don't create any more.
      "preconditionExpr": """!user.studies["cmi-pancan"].forms["ABOUT_CANCER"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    ## Create about-you so it's available in case participant doesn't finish all of the about-cancer ones
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.about_you}
      },
      "preconditionExpr": """!user.studies["cmi-pancan"].forms["ABOUT_YOU"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.about_you}
      },
      "preconditionExpr": """!user.studies["cmi-pancan"].forms["ABOUT_YOU"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    ## Queue up completed email
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_releaseCompleted}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_releaseCompleted}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "cancelExpr": """user.studies["cmi-pancan"].hasAgedUp()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_releaseCompleted}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_releaseCompleted}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 3
    },

    # When DSM notifications received
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "SALIVA_RECEIVED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_salivaReceived}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_salivaReceived}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "BLOOD_SENT"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_bloodSent}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_bloodSent}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "BLOOD_SENT_4WK"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_bloodReminder}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_bloodReminder}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "BLOOD_RECEIVED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_bloodReceived}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_bloodReceived}, "language": "es", "isDynamic": true },
        ],
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },

    //    # join mailing list event
    //    {
    //      "trigger": {
    //        "type": "JOIN_MAILING_LIST"
    //      },
    //      "action": {
    //        "type": "SENDGRID_EMAIL",
    //        "templates": [
    //          {
    //            "emailTemplate": ${emails.en_signStoolCollectionForm}, "language": "en", "isDynamic": true },
    //            "emailTemplate": ${emails.es_signStoolCollectionForm}, "language": "es", "isDynamic": true },
    //        ],
    //        "pdfAttachments": []
    //      },
    //      "dispatchToHousekeeping": true,
    //      "order": 1
    //    },
    //
    //    # pdf generation event for release pdfs
    //    {
    //      "trigger": {
    //        "type": "ACTIVITY_STATUS",
    //        "activityCode": "RELEASE",
    //        "statusType": "COMPLETE"
    //      },
    //      "action": {
    //        "type": "PDF_GENERATION",
    //        "pdfName": "pancanproject-release"
    //      },
    //      "dispatchToHousekeeping": true,
    //      "order": 1
    //    },
    //
    //    # medical update event for release pdfs
    //    {
    //      "trigger": {
    //        "type": "MEDICAL_UPDATE"
    //      },
    //      "action": {
    //        "type": "PDF_GENERATION",
    //        "pdfName": "pancanproject-release"
    //      },
    //      "cancelExpr": """!(user.studies["cmi-pancan"].forms["RELEASE"].hasInstance()
    //            && user.studies["cmi-pancan"].forms["RELEASE"].isStatus("COMPLETE"))"""
    //      "dispatchToHousekeeping": true,
    //      "order": 1
    //    },
    //
    //    # exit request event
  ]
}
