{
  "events": [
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.prequal},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.consent}
      },
      "preconditionExpr": ${_pex.is_self}"&&"${_pex.is_age_of_majority},
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.prequal},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.parental}
      },
      # We want to make sure we did not redirect. Other consent cases check the country, which is a
      # good indicator of not-redirected. We do the same here for parental case.
      "preconditionExpr": ${_pex.is_child_only}"&&"${_pex.is_country_answered}"&&"${_pex.is_age_parental},
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.prequal},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.assent}
      },
      "preconditionExpr": ${_pex.is_child_only}"&&"${_pex.is_age_assent},
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.release}
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    }
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.parental},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.release_minor}
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    }
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.assent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.release_minor}
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    }

    # todo: create about-cancer from prequal cancer selections
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.about_cancer}
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    }
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.release_minor},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.about_cancer}
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    }

    # Consent completion email event
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": "CONSENT",
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consentComplete}, "language": "en",  "isDynamic": true },
          { "emailTemplate": ${emails.es_consentComplete}, "language": "es",  "isDynamic": true }
        ],
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # enrollment events
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "USER_ENROLLED"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.parental},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "USER_ENROLLED"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.assent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "USER_ENROLLED"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },

    # announcement events
    {
      "trigger": {
        "type": "USER_REGISTERED"
      },
      "action": {
        "type": "ANNOUNCEMENT",
        "msgTemplate": ${_includes.announcement_self},
      },
      "preconditionExpr": """user.studies["cmi-pancan"].forms["CONSENT"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "USER_REGISTERED"
      },
      "action": {
        "type": "ANNOUNCEMENT",
        "msgTemplate": ${_includes.announcement_child},
      },
      "preconditionExpr": """!user.studies["cmi-pancan"].forms["CONSENT"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },

//    # join mailing list event
//    {
//      "trigger": {
//        "type": "JOIN_MAILING_LIST"
//      },
//      "action": {
//        "type": "SENDGRID_EMAIL",
//        "templates": [
//          {
//            "emailTemplate": ${emails.en_signStoolCollectionForm}, "language": "en", "isDynamic": true },
//            "emailTemplate": ${emails.es_signStoolCollectionForm}, "language": "es", "isDynamic": true },
//        ],
//        "pdfAttachments": []
//      },
//      "dispatchToHousekeeping": true,
//      "order": 1
//    },
//
//    # populate profile events
//    {
//      "trigger": {
//        "type": "ACTIVITY_STATUS",
//        "activityCode": "PREQUAL",
//        "statusType": "COMPLETE"
//      },
//      "action": {
//        "type": "COPY_ANSWER",
//        "copyConfigPairs": [
//          {
//            "source": {
//              "type": "ANSWER",
//              "questionStableId": "PREQUAL_FIRST_NAME"
//            },
//            "target": {
//              "type": "PARTICIPANT_PROFILE_FIRST_NAME"
//            }
//          },
//          {
//            "source": {
//              "type": "ANSWER",
//              "questionStableId": "PREQUAL_LAST_NAME"
//            },
//            "target": {
//              "type": "PARTICIPANT_PROFILE_LAST_NAME"
//            }
//          }
//        ]
//      },
//      "dispatchToHousekeeping": false,
//      "order": 1
//    },
//
//    # activity instance creation events
//    {
//      "trigger": {
//        "type": "ACTIVITY_STATUS",
//        "activityCode": "PREQUAL",
//        "statusType": "COMPLETE"
//      },
//      "action": {
//        "type": "ACTIVITY_INSTANCE_CREATION",
//        "activityCode": "ABOUTYOU"
//      },
//      "cancelExpr": """
//        !user.studies["cmi-pancan"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
//      """,
//      "maxOccurrencesPerUser": 1,
//      "dispatchToHousekeeping": false,
//      "order": 1
//    }
//
//    # registration event
//    {
//      "trigger": {
//        "type": "USER_REGISTERED",
//      },
//      "action": {
//        "type": "SENDGRID_EMAIL",
//        "templates": [
//          { "emailTemplate": ${emails.en_welcome}, "language": "en", "isDynamic": true }
//          { "emailTemplate": ${emails.es_welcome}, "language": "es", "isDynamic": true }
//        ],
//        "linkedActivityCode": "ABOUTYOU",
//        "pdfAttachments": []
//      },
//      "cancelExpr": """
//        !user.studies["cmi-pancan"].forms["PREQUAL"].hasInstance()
//        || !user.studies["cmi-pancan"].forms["PREQUAL"].questions["PREQUAL_SELF_DESCRIBE"].answers.hasOption("DIAGNOSED")
//      """,
//      "maxOccurrencesPerUser": 1,
//      "dispatchToHousekeeping": true,
//      "order": 1
//    },
//
//    # activity status email events
//    {
//      "trigger": {
//        "type": "ACTIVITY_STATUS",
//        "activityCode": "CONSENT",
//        "statusType": "CREATED"
//      },
//      "action": {
//        "type": "SENDGRID_EMAIL",
//        "templates": [
//          {
//            "emailTemplate": ${emails.aboutyouCompleted},
//            "language": "en",
//            "isDynamic": true
//          }
//        ],
//        "linkedActivityCode": "CONSENT",
//        "pdfAttachments": []
//      },
//      "maxOccurrencesPerUser": 1,
//      "dispatchToHousekeeping": true,
//      "order": 1
//    },
//
//    # pdf generation event for release pdfs
//    {
//      "trigger": {
//        "type": "ACTIVITY_STATUS",
//        "activityCode": "RELEASE",
//        "statusType": "COMPLETE"
//      },
//      "action": {
//        "type": "PDF_GENERATION",
//        "pdfName": "pancanproject-release"
//      },
//      "dispatchToHousekeeping": true,
//      "order": 1
//    },
//
//    # medical update event for release pdfs
//    {
//      "trigger": {
//        "type": "MEDICAL_UPDATE"
//      },
//      "action": {
//        "type": "PDF_GENERATION",
//        "pdfName": "pancanproject-release"
//      },
//      "cancelExpr": """!(user.studies["cmi-pancan"].forms["RELEASE"].hasInstance()
//            && user.studies["cmi-pancan"].forms["RELEASE"].isStatus("COMPLETE"))"""
//      "dispatchToHousekeeping": true,
//      "order": 1
//    },
//
//    # reminder email events
//    {
//      "trigger": {
//        "type": "ACTIVITY_STATUS",
//        "activityCode": "CONSENT",
//        "statusType": "CREATED"
//      },
//      "action": {
//        "type": "SENDGRID_EMAIL",
//        "templates": [
//          { "emailTemplate": ${emails.en_consentFirstReminder}, "language": "en", "isDynamic": true },
//          { "emailTemplate": ${emails.es_consentFirstReminder}, "language": "es", "isDynamic": true },
//        ],
//        "linkedActivityCode": "CONSENT",
//        "pdfAttachments": []
//      },
//      "cancelExpr": """
//        user.studies["cmi-pancan"].forms["CONSENT"].isStatus("COMPLETE")
//        || !user.studies["cmi-pancan"].forms["ABOUTYOU"].questions["COUNTRY"].answers.hasAnyOption("US", "CA", "PR", "GU", "VI", "MP", "AS")
//      """,
//      "delaySeconds": 604800, # one week in seconds
//      "dispatchToHousekeeping": true,
//      "order": 1
//    },
//
//    # dsm notification email events
//    {
//      "trigger": {
//        "type": "DSM_NOTIFICATION",
//        "dsmEvent": "BLOOD_RECEIVED"
//      },
//      "action": {
//        "type": "SENDGRID_EMAIL",
//        "templates": [
//          {
//            "emailTemplate": ${emails.bloodReceived},
//            "language": "en",
//            "isDynamic": true
//          }
//        ],
//        "pdfAttachments": []
//      },
//      "dispatchToHousekeeping": true,
//      "order": 1
//    },
//
//    # exit request event
  ]
}
