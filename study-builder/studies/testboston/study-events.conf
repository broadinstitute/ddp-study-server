{
  "events": [

    # when user registered
    {
      "trigger": {
        "type": "USER_REGISTERED"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.consent}
      },
      "cancelExpr": """
        user.studies["testboston"].forms["CONSENT"].hasInstance()
        || !user.studies["testboston"].hasInvitation("RECRUITMENT")""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "USER_REGISTERED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_account_created}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_account_created}, "language": "es", "isDynamic": true },
          { "emailTemplate": ${emails.ht_account_created}, "language": "ht", "isDynamic": true }
        ],
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 2
    },

    # when completing consent
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "USER_ENROLLED"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.covid_survey}
      },
      "cancelExpr": """user.studies["testboston"].forms["COVID_SURVEY"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.address}
      },
      "cancelExpr": """user.studies["testboston"].forms["ADDRESS"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consent_completed}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consent_completed}, "language": "es", "isDynamic": true },
          { "emailTemplate": ${emails.ht_consent_completed}, "language": "ht", "isDynamic": true }
        ],
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 4
    },

    # when completing address
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.address},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.symptoms_survey}
      },
      "cancelExpr": """user.studies["testboston"].forms["SYMPTOMS_SURVEY"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "delaySeconds" : 259200 #72hrs
      "dispatchToHousekeeping": true,
      "order": 4
    },

    # when CRC created login account for user
    {
      "trigger": {
        "type": "LOGIN_ACCOUNT_CREATED",
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_login_account_created}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_login_account_created}, "language": "es", "isDynamic": true },
          { "emailTemplate": ${emails.ht_login_account_created}, "language": "ht", "isDynamic": true }
        ],
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # when dsm sends notification
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "TESTBOSTON_SENT"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_kit_sent}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_kit_sent}, "language": "es", "isDynamic": true },
          { "emailTemplate": ${emails.ht_kit_sent}, "language": "ht", "isDynamic": true }
        ],
        "pdfAttachments": []
      },
      # This email is only for the first initial kit, so don't send it if we're in longitudinal kit process already.
      "cancelExpr": """user.studies["testboston"].forms["FOLLOWUP_SURVEY"].hasInstance()""",
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "TESTBOSTON_RECEIVED"
      },
      "action": {
        "type": "MARK_ACTIVITIES_READ_ONLY",
        "activityCodes": [${id.act.covid_survey}, ${id.act.followup}]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },

    # when time for longitudinal kit
    {
      "trigger": {
        "type": "KIT_PREP"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.followup}
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.followup},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_next_kit}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_next_kit}, "language": "es", "isDynamic": true },
          { "emailTemplate": ${emails.ht_next_kit}, "language": "ht", "isDynamic": true }
        ],
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 2
    },

  ]
}
