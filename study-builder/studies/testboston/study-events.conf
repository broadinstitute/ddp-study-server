{
  "events": [

    # when CRC created login account for user
    {
      "trigger": {
        "type": "LOGIN_ACCOUNT_CREATED",
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_login_account_created}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_login_account_created}, "language": "es", "isDynamic": true },
          { "emailTemplate": ${emails.ht_login_account_created}, "language": "ht", "isDynamic": true }
        ],
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # when user registered
    {
      "trigger": {
        "type": "USER_REGISTERED"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.consent}
      },
      "cancelExpr": """
        user.studies["testboston"].forms["CONSENT"].hasInstance()
        || !user.studies["testboston"].hasInvitation("RECRUITMENT")""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "USER_REGISTERED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_account_created}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_account_created}, "language": "es", "isDynamic": true },
          { "emailTemplate": ${emails.ht_account_created}, "language": "ht", "isDynamic": true }
        ],
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 2
    },

    # when consent completed
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "USER_ENROLLED"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.baseline_covid}
      },
      "cancelExpr": """user.studies["testboston"].forms["BASELINE_COVID"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.address}
      },
      "cancelExpr": """user.studies["testboston"].forms["ADDRESS"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_consent_completed}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_consent_completed}, "language": "es", "isDynamic": true },
          { "emailTemplate": ${emails.ht_consent_completed}, "language": "ht", "isDynamic": true }
        ],
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 4
    },

    # when baseline covid survey completed
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.baseline_covid},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "COPY_ANSWER",
        "copyConfigPairs": [
          {
            "source": {
              "type": "ANSWER",
              "questionStableId": ${id.q.dob}
            },
            "target": {
              "type": "PARTICIPANT_PROFILE_BIRTH_DATE"
            }
          }
        ]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },

    # when address completed
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.address},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ANNOUNCEMENT",
        "msgTemplate": {
          "templateType": "HTML",
          "templateText": """<p class="infobox-text_small">$tb_done_msg_p1</p>""",
          "variables": [
            {
              "name": "tb_done_msg_p1",
              "translations": [
                { "language": "en", "text": ${i18n.en.banners.enrollment_done} },
                { "language": "es", "text": ${i18n.es.banners.enrollment_done} },
                { "language": "ht", "text": ${i18n.ht.banners.enrollment_done} }
              ]
            }
          ]
        }
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },

    # when kit is shipped
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "TESTBOSTON_SENT"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_kit_sent}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_kit_sent}, "language": "es", "isDynamic": true },
          { "emailTemplate": ${emails.ht_kit_sent}, "language": "ht", "isDynamic": true }
        ],
        "pdfAttachments": []
      },
      # If there is already a Baseline Symptom survey, then this is after the initial kit.
      "cancelExpr": """user.studies["testboston"].forms["BASELINE_SYMPTOM"].hasInstance()""",
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # when kit is delivered
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "TESTBOSTON_DELIVERED"
      },
      "action": {
        "type": "HIDE_ACTIVITIES",
        "activityCodes": [${id.act.longitudinal}],
      },
      "dispatchToHousekeeping": false,
      # IMPORTANT: order matters here.
      "order": 1
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "TESTBOSTON_DELIVERED"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.longitudinal}
      },
      "cancelExpr": """!user.studies["testboston"].forms["BASELINE_SYMPTOM"].hasInstance()""",
      "dispatchToHousekeeping": false,
      # IMPORTANT: order matters here since both relies on this trigger and the presence/absence of Baseline Symptom survey.
      "order": 2
    },
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "TESTBOSTON_DELIVERED"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.baseline_symptom}
      },
      "cancelExpr": """user.studies["testboston"].forms["BASELINE_SYMPTOM"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order":3
    },

    # when baseline symptom survey created
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.baseline_symptom},
        "statusType": "CREATED"
      },
      "action": {
        "type": "MARK_ACTIVITIES_READ_ONLY",
        "activityCodes": [${id.act.baseline_covid}]
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.baseline_symptom},
        "statusType": "CREATED"
      },
      "action": {
        "type": "HIDE_ACTIVITIES",
        "activityCodes": [${id.act.baseline_covid}],
      },
      "dispatchToHousekeeping": false,
      "order": 2
    }
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.baseline_symptom},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_kit_arrived}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_kit_arrived}, "language": "es", "isDynamic": true },
          { "emailTemplate": ${emails.ht_kit_arrived}, "language": "ht", "isDynamic": true }
        ],
        "linkedActivityCode": ${id.act.baseline_symptom},
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 3
    },

    # when baseline symptom survey completed
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.baseline_symptom},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ANNOUNCEMENT",
        "msgTemplate": {
          "templateType": "HTML",
          "templateText": """<p class="infobox-text_small">$tb_next_msg_p1</p>""",
          "variables": [
            {
              "name": "tb_next_msg_p1",
              "translations": [
                { "language": "en", "text": ${i18n.en.banners.whats_next} },
                { "language": "es", "text": ${i18n.es.banners.whats_next} },
                { "language": "ht", "text": ${i18n.ht.banners.whats_next} }
              ]
            }
          ]
        }
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.baseline_symptom},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.adhoc_symptom}
      },
      "cancelExpr": """user.studies["testboston"].forms["ADHOC_SYMPTOM"].hasInstance()
          || !user.studies["testboston"].forms["BASELINE_COVID"].questions["INTERESTED_CONTINUING"].isAnswered()
          || user.studies["testboston"].forms["BASELINE_COVID"].questions["INTERESTED_CONTINUING"].answers.hasFalse()
          """,
      "maxOccurrencesPerUser": 1,
      "delaySeconds": 21600, # 6 hrs
      "dispatchToHousekeeping": true,
      "order": 2
    },

    # when time for longitudinal kit
    {
      "trigger": {
        "type": "KIT_PREP",
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_next_kit}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_next_kit}, "language": "es", "isDynamic": true },
          { "emailTemplate": ${emails.ht_next_kit}, "language": "ht", "isDynamic": true }
        ],
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # when longitudinal covid survey created
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.longitudinal},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_kit_arrived}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_kit_arrived}, "language": "es", "isDynamic": true },
          { "emailTemplate": ${emails.ht_kit_arrived}, "language": "ht", "isDynamic": true }
        ],
        "linkedActivityCode": ${id.act.longitudinal},
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.longitudinal},
        "statusType": "CREATED"
      },
      "action": {
        "type": "HIDE_ACTIVITIES",
        "activityCodes": [${id.act.baseline_symptom}],
      },
      "dispatchToHousekeeping": false,
      "order": 2
    }

    # when longitudinal covid survey completed
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.longitudinal},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.adhoc_symptom}
      },
      "cancelExpr": """user.studies["testboston"].forms["ADHOC_SYMPTOM"].hasInstance()
          || !user.studies["testboston"].forms["BASELINE_COVID"].questions["INTERESTED_CONTINUING"].isAnswered()
          || user.studies["testboston"].forms["BASELINE_COVID"].questions["INTERESTED_CONTINUING"].answers.hasFalse()
          """,
      "delaySeconds": 21600, # 6 hrs
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # when kit is received back in lab
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "TESTBOSTON_RECEIVED"
      },
      "action": {
        "type": "MARK_ACTIVITIES_READ_ONLY",
        "activityCodes": [${id.act.baseline_covid}, ${id.act.baseline_symptom}, ${id.act.longitudinal}]
      },
      "dispatchToHousekeeping": false,
      "order": 1
    },

    # when test result is available
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "TEST_RESULT"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.result_report}
      },
      "cancelExpr": "user.event.testResult.isCorrected()",
      "dispatchToHousekeeping": false,
      "order": 1
    },

    # when result-report survey created
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.result_report},
        "statusType": "CREATED"
      },
      "action": {
        "type": "MARK_ACTIVITIES_READ_ONLY",
        "activityCodes": [${id.act.baseline_symptom}]
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.result_report},
        "statusType": "CREATED"
      },
      "action": {
        "type": "HIDE_ACTIVITIES",
        "activityCodes": [${id.act.baseline_symptom}],
      },
      "dispatchToHousekeeping": false,
      "order": 2
    }
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.result_report},
        "statusType": "CREATED"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.adhoc_symptom}
      },
      "cancelExpr": """user.studies["testboston"].forms["ADHOC_SYMPTOM"].hasInstance()
          || !user.studies["testboston"].forms["BASELINE_COVID"].questions["INTERESTED_CONTINUING"].isAnswered()
          || user.studies["testboston"].forms["BASELINE_COVID"].questions["INTERESTED_CONTINUING"].answers.hasFalse()
          """,
      "dispatchToHousekeeping": false,
      "order": 3
    }
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.result_report},
        "statusType": "CREATED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "templates": [
          { "emailTemplate": ${emails.en_result_report_created}, "language": "en", "isDynamic": true },
          { "emailTemplate": ${emails.es_result_report_created}, "language": "es", "isDynamic": true },
          { "emailTemplate": ${emails.ht_result_report_created}, "language": "ht", "isDynamic": true }
        ],
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 2
    },
  ]
}
