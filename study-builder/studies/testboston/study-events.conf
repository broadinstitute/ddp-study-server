{
  "events": [

    # when user registered
    {
      "trigger": {
        "type": "USER_REGISTERED"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.consent}
      },
      "cancelExpr": """
        user.studies["testboston"].forms["CONSENT"].hasInstance()
        || !user.studies["testboston"].hasInvitation("RECRUITMENT")""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "USER_REGISTERED"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.accountCreated},
        "language": "en",
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 2
    },

    # when completing consent
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "USER_ENROLLED"
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 1
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.covid_survey}
      },
      "cancelExpr": """user.studies["testboston"].forms["COVID_SURVEY"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 2
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "ACTIVITY_INSTANCE_CREATION",
        "activityCode": ${id.act.address}
      },
      "cancelExpr": """user.studies["testboston"].forms["ADDRESS"].hasInstance()""",
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": false,
      "order": 3
    },
    {
      "trigger": {
        "type": "ACTIVITY_STATUS",
        "activityCode": ${id.act.consent},
        "statusType": "COMPLETE"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.consentCompleted},
        "language": "en",
        "pdfAttachments": [
           { "pdfName": "testboston-consent", "generateIfMissing": true }
        ]
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 4
    },

    # when CRC created login account for user
    {
      "trigger": {
        "type": "LOGIN_ACCOUNT_CREATED",
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.loginAccountCreated},
        "language": "en",
        "pdfAttachments": []
      },
      "maxOccurrencesPerUser": 1,
      "dispatchToHousekeeping": true,
      "order": 1
    },

    # when dsm sends notification
    {
      "trigger": {
        "type": "DSM_NOTIFICATION",
        "dsmEvent": "TESTBOSTON_SENT"
      },
      "action": {
        "type": "SENDGRID_EMAIL",
        "emailTemplate": ${emails.kitSent},
        "language": "en",
        "pdfAttachments": []
      },
      "dispatchToHousekeeping": true,
      "order": 1
    },

  ]
}
